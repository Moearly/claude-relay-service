# Claude Relay Service 项目实现原理分析

## 📋 项目概述

**Claude Relay Service** 是一个自托管的 Claude API 中转服务，支持多账户管理、智能调度、API Key 认证等功能。

- **项目类型**: Node.js 后端服务 + Vue.js 前端管理界面
- **核心技术栈**: Express.js + Redis + Vue 3
- **主要功能**: API 中转、账户池管理、使用统计、费用追踪

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                              │
├─────────────────────────────────────────────────────────────┤
│  Claude Code CLI  │  Gemini CLI  │  Codex  │  第三方工具     │
└──────────────┬──────────────────────────────────────────────┘
               │ API请求 (携带 API Key)
               ▼
┌─────────────────────────────────────────────────────────────┐
│                    Claude Relay Service                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              中间件层 (Middleware)                   │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • API Key 认证  • 速率限制  • 客户端验证           │   │
│  │  • 并发控制      • 模型限制  • 费用检查             │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ▼                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              路由层 (Routes)                         │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  /api/v1/messages     - Claude API 标准格式          │   │
│  │  /claude/v1/messages  - Claude API 别名              │   │
│  │  /gemini/v1/messages  - Gemini API 格式              │   │
│  │  /openai/v1/chat      - OpenAI 兼容格式 (Codex)     │   │
│  │  /admin/*             - 管理后台 API                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ▼                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            服务层 (Services)                         │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • unifiedClaudeScheduler  - 统一账户调度服务        │   │
│  │  • claudeRelayService      - Claude 请求转发服务     │   │
│  │  • apiKeyService           - API Key 管理服务        │   │
│  │  • claudeAccountService    - Claude 账户管理服务     │   │
│  │  • pricingService          - 定价和费用计算服务      │   │
│  │  • tokenRefreshService     - Token 自动刷新服务      │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ▼                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │            数据层 (Redis)                            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  • API Keys 数据         • 账户池信息                │   │
│  │  • 使用统计             • 费用记录                   │   │
│  │  • 会话映射 (Sticky)     • 速率限制状态              │   │
│  │  • Token 缓存           • 账户状态                   │   │
│  └─────────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │ 上游 API 请求
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    上游 API 服务                              │
├─────────────────────────────────────────────────────────────┤
│  Anthropic API  │  Gemini API  │  OpenAI API  │  Bedrock    │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔑 核心实现原理

### 1. API Key 认证机制

#### 工作流程

```javascript
// 文件: src/services/apiKeyService.js

1. API Key 生成
   └─> generateApiKey()
       ├─> 生成 64 位随机密钥: cr_[随机字符串]
       ├─> 使用 SHA-256 哈希存储 (安全性)
       └─> 保存到 Redis: apikey:[keyId] 和 apikey_hash:[hashedKey]

2. API Key 验证
   └─> validateApiKey()
       ├─> 检查格式: 是否以 "cr_" 开头
       ├─> 计算哈希: SHA-256(apiKey)
       ├─> Redis 查询: 通过 apikey_hash:[hash] 快速查找
       ├─> 状态检查: isActive、是否过期、用户是否禁用
       ├─> 首次使用激活: activation 模式下自动激活并计算过期时间
       └─> 返回验证结果和 API Key 元数据
```

#### 关键特性

- **哈希存储**: 只存储 SHA-256 哈希，不存储明文
- **快速查找**: 使用 Redis Hash 映射实现 O(1) 查询
- **激活模式**: 支持固定过期时间和首次使用后激活两种模式
- **权限控制**: 支持模型限制、客户端限制、并发限制等

---

### 2. 多账户调度系统

#### 统一调度器 (UnifiedClaudeScheduler)

```javascript
// 文件: src/services/unifiedClaudeScheduler.js

账户选择优先级:
┌────────────────────────────────────────────┐
│ 1. 检查 API Key 专属绑定                    │
│    ├─> claudeAccountId (专属 Claude 账户)   │
│    ├─> group:xxx (账户组)                   │
│    └─> 其他账户类型绑定                      │
└────────────┬───────────────────────────────┘
             │ 如果绑定账户不可用 ↓
┌────────────────────────────────────────────┐
│ 2. Sticky Session 会话粘性                  │
│    ├─> 检查 sessionHash (基于会话内容)      │
│    ├─> Redis 查询: unified_claude_session_  │
│    └─> 如果存在且账户可用，继续使用          │
└────────────┬───────────────────────────────┘
             │ 无 Sticky Session ↓
┌────────────────────────────────────────────┐
│ 3. 账户池轮询 (Round-Robin + 健康检查)      │
│    ├─> 获取所有可调度账户                   │
│    ├─> 过滤条件:                            │
│    │   • isActive = true                    │
│    │   • status ≠ error                     │
│    │   • schedulable ≠ false                │
│    │   • 不在限流状态                        │
│    │   • 支持请求的模型 (Opus 检查等)        │
│    ├─> 按 lastUsedAt 排序 (最久未用优先)    │
│    ├─> 选择第一个可用账户                   │
│    └─> 更新 lastUsedAt 时间戳               │
└────────────┬───────────────────────────────┘
             │
             ▼
        返回选中的账户
```

#### 账户健康检查

```
账户状态管理:
┌──────────────────────────────────────────────┐
│ 正常状态 (active)                             │
├──────────────────────────────────────────────┤
│ • 可正常调度                                  │
│ • 参与轮询                                    │
└──────────┬───────────────────────────────────┘
           │
           │ API 请求失败 ↓
┌──────────────────────────────────────────────┐
│ 限流状态 (rate_limited)                       │
├──────────────────────────────────────────────┤
│ • 429 状态码触发                              │
│ • 设置 rateLimitEndAt 时间戳                  │
│ • 自动排除出调度池                            │
│ • 限流清理服务定期检查并恢复                   │
└──────────┬───────────────────────────────────┘
           │
           │ Token 过期/账户错误 ↓
┌──────────────────────────────────────────────┐
│ 错误状态 (error)                              │
├──────────────────────────────────────────────┤
│ • 401/403 等认证错误触发                      │
│ • 完全排除出调度池                            │
│ • 需要手动刷新 Token 或重新授权               │
└──────────────────────────────────────────────┘
```

---

### 3. 会话粘性 (Sticky Session)

#### 实现原理

```javascript
// 文件: src/utils/sessionHelper.js

会话哈希生成:
└─> generateSessionHash(requestBody)
    ├─> 提取关键字段: system、messages (前5条)
    ├─> 序列化为稳定字符串
    ├─> 计算 SHA-256 哈希
    └─> 返回 sessionHash (缓存键)

会话映射存储 (Redis):
Key: unified_claude_session_mapping:[sessionHash]
Value: accountId
TTL: 1小时 (可配置)

工作流程:
1. 请求到达 → 生成 sessionHash
2. Redis 查询 → 检查是否有映射
3. 如果有 → 优先使用该账户 (会话连续性)
4. 如果无 → 正常调度 + 创建新映射
5. 续期机制 → 活跃会话自动延长 TTL
```

#### 使用场景

- **多轮对话**: 保持上下文连续性
- **长时间任务**: 避免会话中断切换账户
- **Claude Code**: 保持编码会话的一致性

---

### 4. 请求转发机制

#### Claude API 请求转发流程

```javascript
// 文件: src/services/claudeRelayService.js

请求处理流程:
┌─────────────────────────────────────────────┐
│ 1. 请求预处理                                │
├─────────────────────────────────────────────┤
│ • 模型限制检查                               │
│ • 并发限制检查 (Redis 信号量)                │
│ • 费用限制检查 (日/周/总)                    │
│ • 生成 sessionHash                          │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 2. 账户选择                                  │
├─────────────────────────────────────────────┤
│ • unifiedClaudeScheduler.selectAccount()    │
│ • 获取账户的 accessToken                     │
│ • 检查 Token 有效性 (自动刷新)               │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 3. 构建上游请求                              │
├─────────────────────────────────────────────┤
│ • 设置请求头:                                │
│   - Authorization: Bearer [accessToken]     │
│   - anthropic-version: 2023-06-01          │
│   - anthropic-beta: claude-code-...        │
│   - User-Agent: Claude Code 官方 UA        │
│ • 处理代理配置 (HTTP/SOCKS5)                 │
│ • 设置超时 (默认 10 分钟)                    │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 4. 流式响应处理                              │
├─────────────────────────────────────────────┤
│ • 监听上游响应事件:                          │
│   - data: 转发数据块 + Token 统计            │
│   - error: 错误处理 + 账户状态更新           │
│   - end: 完成处理 + 费用计算                 │
│ • 实时统计:                                  │
│   - inputTokens: 累计输入 Token              │
│   - outputTokens: 累计输出 Token             │
│   - cacheTokens: 缓存 Token (节省费用)       │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 5. 后处理                                    │
├─────────────────────────────────────────────┤
│ • 费用计算和记录 (pricingService)            │
│ • 使用统计更新 (Redis)                       │
│ • 释放并发槽位                               │
│ • 更新账户 lastUsedAt                        │
│ • Webhook 通知 (可选)                        │
└─────────────────────────────────────────────┘
```

---

### 5. Token 自动刷新机制

#### OAuth Token 管理

```javascript
// 文件: src/services/tokenRefreshService.js

Token 刷新策略:
┌─────────────────────────────────────────────┐
│ 1. 被动刷新 (请求时检查)                     │
├─────────────────────────────────────────────┤
│ • getValidAccessToken() 调用时               │
│ • 检查 accessTokenExpiresAt                 │
│ • 提前 5 分钟预刷新                          │
│ • 使用 refreshToken 获取新 accessToken      │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 2. 主动刷新 (定时任务)                       │
├─────────────────────────────────────────────┤
│ • 每 1 小时扫描所有账户                      │
│ • 过滤即将过期的 Token (30 分钟内)          │
│ • 批量刷新 (避免请求时阻塞)                  │
└─────────────────────────────────────────────┘

Token 存储结构 (Redis):
claude_account:[accountId]
├─> accessToken: 访问令牌
├─> refreshToken: 刷新令牌 (加密存储)
├─> accessTokenExpiresAt: 过期时间戳
└─> lastTokenRefresh: 最后刷新时间
```

---

### 6. 费用计算和统计

#### 定价服务 (PricingService)

```javascript
// 文件: src/services/pricingService.js

定价数据来源:
└─> resources/model-pricing/model_prices_and_context_window.json
    ├─> 模型价格表
    ├─> 输入/输出 Token 单价
    ├─> 缓存 Token 折扣
    └─> 上下文窗口大小

费用计算公式:
totalCost = (inputTokens × inputPrice) 
          + (outputTokens × outputPrice)
          + (cacheCreationTokens × cacheWritePrice)
          + (cacheReadTokens × cacheReadPrice)

示例 (Claude Sonnet 4.5):
• 输入: $3.00 / 1M tokens
• 输出: $15.00 / 1M tokens
• 缓存写入: $3.75 / 1M tokens
• 缓存读取: $0.30 / 1M tokens
```

#### 使用统计记录

```
Redis 数据结构:
┌─────────────────────────────────────────────┐
│ API Key 使用统计                             │
├─────────────────────────────────────────────┤
│ apikey_stats:[keyId]                        │
│ ├─> totalRequests: 总请求数                 │
│ ├─> inputTokens: 输入 Token 总量             │
│ ├─> outputTokens: 输出 Token 总量            │
│ ├─> totalCost: 总费用 (USD)                 │
│ ├─> dailyCost: 今日费用                     │
│ └─> weeklyOpusCost: 本周 Opus 费用          │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 账户使用统计                                 │
├─────────────────────────────────────────────┤
│ account_stats:[accountId]                   │
│ ├─> totalRequests: 总请求数                 │
│ ├─> successRequests: 成功请求数              │
│ ├─> failedRequests: 失败请求数               │
│ └─> lastUsedAt: 最后使用时间                │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 请求历史记录                                 │
├─────────────────────────────────────────────┤
│ request_history:[keyId]:[timestamp]         │
│ ├─> model: 使用的模型                        │
│ ├─> tokens: Token 使用详情                  │
│ ├─> cost: 本次费用                          │
│ ├─> accountId: 使用的账户                    │
│ └─> duration: 请求耗时                       │
│ TTL: 30 天 (可配置)                         │
└─────────────────────────────────────────────┘
```

---

### 7. 速率限制和并发控制

#### 三层限制机制

```javascript
// 1. API Key 级别速率限制
rateLimitWindow: 60000,      // 1 分钟窗口
rateLimitRequests: 100,      // 最多 100 请求
rateLimitCost: 1.0,          // 或最多 $1.00 费用

实现: Redis 滑动窗口计数器
Key: ratelimit:[keyId]:[timestamp/window]

// 2. 并发控制
concurrencyLimit: 5          // 最多 5 个并发请求

实现: Redis 信号量
Key: concurrency:[keyId]
Value: Set<requestId>

// 3. 费用限制
dailyCostLimit: 10.0,        // 每日最多 $10
totalCostLimit: 100.0,       // 总共最多 $100
weeklyOpusCostLimit: 50.0    // 每周 Opus 最多 $50

实现: Redis 累计计数器
Key: cost:[keyId]:daily/total/weekly
```

---

### 8. 安全机制

#### 数据加密

```javascript
// 文件: config/config.js

敏感数据加密:
└─> ENCRYPTION_KEY (32 字符 AES-256-CBC)
    ├─> refreshToken 加密存储
    ├─> OAuth credentials 加密
    └─> 代理密码加密

JWT 认证:
└─> JWT_SECRET
    ├─> 管理员登录 Token
    ├─> 用户登录 Token
    └─> 24 小时过期
```

#### 请求验证

```javascript
中间件链:
┌─────────────────────────────────────────────┐
│ 1. Helmet 安全头                             │
│    • XSS 防护                                │
│    • CSRF 防护                               │
│    • Content-Type 嗅探防护                   │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 2. CORS 跨域控制                             │
│    • 允许的源检查                            │
│    • 凭证检查                                │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 3. 请求大小限制                              │
│    • Body: 10MB                             │
│    • JSON 格式验证                           │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 4. API Key 认证                              │
│    • 格式验证                                │
│    • 哈希查找                                │
│    • 权限检查                                │
└──────────┬──────────────────────────────────┘
           ▼
┌─────────────────────────────────────────────┐
│ 5. 客户端验证 (可选)                         │
│    • User-Agent 检查                        │
│    • 白名单匹配                              │
└─────────────────────────────────────────────┘
```

---

## 🗄️ 数据存储结构

### Redis Key 设计

```
API Keys:
├─> apikey:[keyId]                    # API Key 元数据 (Hash)
└─> apikey_hash:[hashedKey]           # 哈希到 ID 映射 (String)

Claude 账户:
├─> claude_account:[accountId]        # 账户信息 (Hash)
├─> claude_accounts                   # 所有账户 ID 列表 (Set)
└─> claude_oauth_tokens:[accountId]   # OAuth Token 缓存 (Hash)

会话管理:
└─> unified_claude_session_mapping:[sessionHash]  # 会话粘性 (String, TTL: 1h)

限流控制:
├─> ratelimit:[keyId]:[window]        # 速率限制计数器 (String, TTL)
├─> concurrency:[keyId]               # 并发控制 (Set)
└─> account_ratelimit:[accountId]     # 账户限流状态 (Hash)

统计数据:
├─> apikey_stats:[keyId]              # API Key 使用统计 (Hash)
├─> account_stats:[accountId]         # 账户使用统计 (Hash)
└─> request_history:[keyId]:[ts]      # 请求历史 (Hash, TTL: 30d)

费用追踪:
├─> cost:[keyId]:daily                # 每日费用 (String, TTL: 1d)
├─> cost:[keyId]:total                # 总费用 (String)
└─> cost:[keyId]:weekly_opus          # 每周 Opus 费用 (String, TTL: 7d)

系统缓存:
├─> pricing_cache                     # 定价数据缓存 (Hash)
└─> model_mapping_cache               # 模型映射缓存 (Hash)
```

---

## 🔄 关键流程时序图

### 完整请求处理流程

```
客户端          API网关        调度器         账户池        Anthropic API
  │               │              │             │                │
  │─────1. POST /api/v1/messages────>│           │                │
  │    (API Key: cr_xxx)        │              │                │
  │               │              │             │                │
  │               │─────2. 验证 API Key───────>│                │
  │               │<────有效 + 元数据──────────│                │
  │               │              │             │                │
  │               │──3. 选择账户──>│            │                │
  │               │              │─4. 查询会话─>│                │
  │               │              │<─有映射/无──│                │
  │               │              │─5. 轮询账户─>│                │
  │               │              │<─accountId──│                │
  │               │<─accountId───│             │                │
  │               │              │             │                │
  │               │─────6. 获取 Token──────────>│                │
  │               │<────accessToken────────────│                │
  │               │              │             │                │
  │               │─────────7. 转发请求─────────────────────────>│
  │               │              │             │                │
  │               │<────────8. 流式响应 (SSE)───────────────────│
  │<──9. 转发响应──│              │             │                │
  │   (实时流式)   │              │             │                │
  │               │              │             │                │
  │               │─────10. 统计和计费────────>│                │
  │               │              (Token 计数、费用计算)          │
  │               │              │             │                │
  │<──11. 完成────│              │             │                │
```

---

## 🎯 核心特性实现细节

### 1. Opus 模型限流处理

```javascript
Opus 特殊限制:
• 检测: 模型名包含 "opus" (不区分大小写)
• 限制类型:
  └─> 周使用限制 (Claude Pro/Free 账户)
      ├─> 触发条件: 429 + 特定错误信息
      ├─> 限制时长: 7 天 (从周一开始计算)
      └─> 自动恢复: 每周一 UTC 00:00

处理流程:
1. 请求前检查: clearExpiredOpusRateLimit()
2. 专属账户检查: 如果限流，返回 403
3. 池账户策略: 跳过限流账户，选择其他
4. 响应解析: 捕获 429 错误，标记账户
```

### 2. 多供应商支持

```javascript
支持的账户类型:
├─> Claude Official (OAuth)
│   ├─> 官方 Claude Code 账户
│   ├─> 支持 Max/Pro/Free 套餐
│   └─> 自动 Token 刷新
│
├─> Claude Console
│   ├─> Anthropic 开发者控制台
│   ├─> API Key 认证
│   └─> 模型权限控制
│
├─> AWS Bedrock
│   ├─> AWS IAM 认证
│   ├─> 区域选择
│   └─> 模型版本映射
│
├─> Gemini
│   ├─> Google OAuth
│   ├─> Gemini CLI 兼容
│   └─> 独立调度器
│
└─> OpenAI Responses (Codex)
    ├─> OpenAI OAuth
    ├─> responses.openai.com API
    └─> 模型名映射: gpt-5
```

### 3. 代理支持

```javascript
// 文件: src/utils/proxyHelper.js

代理类型支持:
├─> HTTP/HTTPS 代理
│   └─> HttpsProxyAgent
│
└─> SOCKS5 代理
    └─> SocksProxyAgent

配置方式:
1. 全局代理 (环境变量)
   └─> HTTP_PROXY / HTTPS_PROXY

2. 账户级别代理
   └─> staticProxy: "http://user:pass@ip:port"

3. 动态代理 (代码内配置)
   └─> dynamicProxy: { ... }

特性:
• 自动代理类型检测
• 连接池复用
• 超时控制
• 错误重试
```

---

## 📊 性能优化

### 1. 缓存策略

```javascript
多层缓存架构:
┌─────────────────────────────────────────────┐
│ L1: 内存缓存 (LRU)                           │
├─────────────────────────────────────────────┤
│ • 定价数据 (1000 条)                         │
│ • 模型映射 (500 条)                          │
│ • 解密结果 (100 条)                          │
│ TTL: 1 小时                                 │
└──────────┬──────────────────────────────────┘
           ▼ Cache Miss
┌─────────────────────────────────────────────┐
│ L2: Redis 缓存                               │
├─────────────────────────────────────────────┤
│ • 账户信息                                   │
│ • API Key 数据                              │
│ • Token 缓存                                │
│ TTL: 根据数据类型                            │
└──────────┬──────────────────────────────────┘
           ▼ Cache Miss
┌─────────────────────────────────────────────┐
│ L3: 数据源 (文件/API)                        │
├─────────────────────────────────────────────┤
│ • JSON 配置文件                              │
│ • 上游 API 调用                              │
└─────────────────────────────────────────────┘
```

### 2. 连接池管理

```javascript
HTTP 连接池:
• keepAlive: true
• maxSockets: 50
• maxFreeSockets: 10
• timeout: 60000
• 复用连接，减少握手开销

Redis 连接池:
• 连接复用
• 命令管道化 (pipeline)
• 自动重连
• 健康检查
```

### 3. 请求优化

```javascript
优化措施:
├─> 流式响应 (SSE)
│   └─> 边接收边转发，降低延迟
│
├─> 并发控制
│   └─> 信号量机制，避免过载
│
├─> 错误快速失败
│   └─> 及时释放资源
│
└─> 异步处理
    └─> 统计、日志异步写入
```

---

## 🛡️ 容错和恢复

### 自动恢复机制

```javascript
错误处理策略:
┌─────────────────────────────────────────────┐
│ Token 过期 (401)                             │
├─────────────────────────────────────────────┤
│ • 自动调用 refreshToken                      │
│ • 重试原请求 (最多 1 次)                     │
│ • 失败后标记账户 error                       │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 限流 (429)                                   │
├─────────────────────────────────────────────┤
│ • 解析 retry-after 头                        │
│ • 设置 rateLimitEndAt                       │
│ • 临时排除出调度池                           │
│ • 定时任务自动恢复                           │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 网络错误 (ETIMEDOUT, ECONNRESET)            │
├─────────────────────────────────────────────┤
│ • 标记临时错误 (tempError)                   │
│ • 5 分钟后自动清除                           │
│ • 不影响账户长期可用性                       │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 上游服务错误 (5xx)                           │
├─────────────────────────────────────────────┤
│ • 降级处理                                   │
│ • 尝试其他账户                               │
│ • 返回友好错误消息                           │
└─────────────────────────────────────────────┘
```

### 健康监控

```javascript
健康检查端点: /health

返回信息:
{
  "status": "healthy",
  "version": "1.0.0",
  "uptime": 3600,
  "components": {
    "redis": {
      "status": "healthy",
      "latency": "2ms"
    },
    "logger": {
      "status": "healthy"
    }
  },
  "memory": {
    "used": "128MB",
    "total": "256MB"
  }
}

监控指标: /metrics
• 请求统计
• 账户状态
• Token 使用
• 错误率
```

---

## 📝 日志系统

### 分级日志

```javascript
// 文件: src/utils/logger.js

日志级别:
• error   - 错误 (始终记录)
• warn    - 警告
• info    - 信息 (默认)
• debug   - 调试
• verbose - 详细

日志文件:
├─> logs/error-%DATE%.log      # 错误日志 (7 天)
├─> logs/combined-%DATE%.log   # 综合日志 (5 天)
└─> logs/http-debug-%DATE%.log # HTTP 调试 (可选)

日志格式:
[2025-01-10 14:30:25] [INFO] 🔑 Generated new API key: TestKey (uuid)
```

---

## 🔧 配置管理

### 环境变量优先级

```
配置加载顺序 (从高到低):
1. 环境变量 (process.env)
2. .env 文件 (dotenv)
3. config/config.js 默认值
4. 硬编码默认值

关键配置:
┌─────────────────────────────────────────────┐
│ 安全配置 (必填)                              │
├─────────────────────────────────────────────┤
│ • JWT_SECRET          - JWT 签名密钥         │
│ • ENCRYPTION_KEY      - 数据加密密钥 (32位)  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ Redis 配置                                   │
├─────────────────────────────────────────────┤
│ • REDIS_HOST          - Redis 地址           │
│ • REDIS_PORT          - Redis 端口           │
│ • REDIS_PASSWORD      - Redis 密码 (可选)    │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 服务配置                                     │
├─────────────────────────────────────────────┤
│ • PORT                - 服务端口 (默认 3000) │
│ • HOST                - 监听地址 (默认 0.0.0.0) │
│ • NODE_ENV            - 环境 (production)    │
└─────────────────────────────────────────────┘
```

---

## 🎨 前端管理界面

### 技术栈

```
框架: Vue 3 + Vite
UI 库: Tailwind CSS
状态管理: Pinia
路由: Vue Router
图表: ECharts
HTTP: Axios

构建产物: web/admin-spa/dist/
路由: /admin-next/*
```

### 主要功能页面

```
├─> /admin-next/api-stats      # API 使用统计
├─> /admin-next/api-keys       # API Key 管理
├─> /admin-next/accounts       # 账户管理
│   ├─> Claude 账户
│   ├─> Gemini 账户
│   └─> Codex 账户
├─> /admin-next/users          # 用户管理
├─> /admin-next/settings       # 系统设置
└─> /admin-next/login          # 登录页面
```

---

## 🚀 部署架构

### Docker 部署

```yaml
services:
  claude-relay:
    image: weishaw/claude-relay-service:latest
    ports:
      - "3000:3000"
    environment:
      - JWT_SECRET=xxx
      - ENCRYPTION_KEY=xxx
      - REDIS_HOST=redis
    depends_on:
      - redis
  
  redis:
    image: redis:7-alpine
    command: redis-server --save 60 1 --appendonly yes
    volumes:
      - redis_data:/data
```

### 生产环境推荐

```
架构:
Internet
    │
    ▼
┌─────────────────┐
│  Caddy/Nginx    │  ← HTTPS 终止 + 反向代理
│  (443/80)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Claude Relay    │  ← Node.js 应用
│ (127.0.0.1:3000)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Redis           │  ← 数据存储
│ (127.0.0.1:6379)│
└─────────────────┘

优势:
• 自动 HTTPS (Let's Encrypt)
• 负载均衡
• 流式响应支持
• 安全头部
• 日志记录
```

---

## 📈 扩展性设计

### 水平扩展

```javascript
支持多实例部署:
• 无状态设计 (状态存 Redis)
• 共享 Redis 集群
• 负载均衡器分发
• 会话粘性通过 sessionHash 实现

扩展方案:
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Instance│     │ Instance│     │ Instance│
│    1    │     │    2    │     │    3    │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     └───────────────┼───────────────┘
                     │
              ┌──────▼──────┐
              │ Redis Cluster│
              └─────────────┘
```

### 插件化设计

```javascript
服务模块化:
• 账户服务可插拔 (Claude/Gemini/Codex)
• 定价服务可自定义
• 通知服务可扩展 (Webhook)
• 认证服务可替换 (LDAP)

扩展点:
├─> src/services/          # 新增服务
├─> src/validators/        # 新增验证器
├─> src/routes/            # 新增路由
└─> config/                # 新增配置
```

---

## 🔍 故障排查

### 常见问题

```
1. API Key 验证失败
   └─> 检查: Redis 连接、哈希计算、过期时间

2. 账户无法调度
   └─> 检查: isActive、status、schedulable、限流状态

3. Token 刷新失败
   └─> 检查: refreshToken 有效性、网络连接、OAuth 配置

4. 请求超时
   └─> 检查: 代理配置、超时设置、上游 API 状态

5. 费用统计不准确
   └─> 检查: 定价数据、Token 统计、时区设置

调试工具:
• 日志文件: logs/combined-*.log
• Redis CLI: redis-cli -h localhost
• 健康检查: curl http://localhost:3000/health
• 指标接口: curl http://localhost:3000/metrics
```

---

## 📚 总结

### 核心优势

1. **统一调度**: 多类型账户统一管理和调度
2. **智能路由**: 会话粘性 + 健康检查 + 负载均衡
3. **费用透明**: 实时统计 + 详细记录 + 限额控制
4. **高可用**: 自动恢复 + 故障隔离 + 优雅降级
5. **易扩展**: 模块化设计 + 插件机制 + 水平扩展

### 技术亮点

- ✅ **OAuth 自动刷新**: 无缝 Token 管理
- ✅ **流式响应**: 低延迟实时传输
- ✅ **多层缓存**: 性能优化
- ✅ **并发控制**: 资源保护
- ✅ **费用追踪**: 成本透明
- ✅ **监控完善**: 健康检查 + 指标暴露

### 适用场景

- 🎯 多人共享 Claude Code Max 订阅
- 🎯 企业内部 API 中转和管理
- 🎯 开发团队 API 使用统计和限额
- 🎯 多账户池高可用部署
- 🎯 成本控制和费用分析

---

**文档版本**: v1.0  
**生成时间**: 2025-01-10  
**项目仓库**: https://github.com/Wei-Shaw/claude-relay-service

