#!/bin/bash

###############################################################################
# 后端部署脚本 - 优化版
# 用途：部署后端代码到生产服务器
# 特点：
#   1. 最小化 SSH 连接次数（共 3 次）
#   2. 连接间隔 15-20 秒，避免服务器限制
#   3. 完整的错误处理和验证
###############################################################################

set -e  # 遇到错误立即退出

# ============================================================================
# 颜色定义
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# 服务器配置
# ============================================================================
SERVER="root@156.229.163.86"
PASSWORD="jR74pQyDMTRt*eti7@"
DIR="/opt/claude-relay-service"
API_BASE_URL="https://api.codewith.site"
BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S).tar.gz"

# ============================================================================
# 辅助函数
# ============================================================================
log() {
  echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
  echo -e "${GREEN}✓${NC} $1"
}

warn() {
  echo -e "${YELLOW}⚠${NC} $1"
}

error() {
  echo -e "${RED}✗ 错误:${NC} $1"
  exit 1
}

ssh_run() {
  sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no "$SERVER" "$1"
}

# ============================================================================
# 主要部署流程
# ============================================================================

echo ""
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║          🚀 后端部署脚本 - 优化版                              ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""

# ----------------------------------------------------------------------------
# 第 1 阶段：测试连接并备份
# ----------------------------------------------------------------------------
log "📡 第 1 次 SSH：测试连接并备份..."
ssh_run "echo '连接成功' && cd $DIR && mkdir -p backups && tar -czf backups/$BACKUP_NAME src/routes/admin.js src/routes/referralRoutes.js src/app.js 2>/dev/null || true" || error "连接或备份失败"
success "连接正常，备份完成"

log "⏳ 等待 15 秒..."
sleep 15

# ----------------------------------------------------------------------------
# 第 2 阶段：上传文件（一次性上传所有文件）
# ----------------------------------------------------------------------------
log "📤 上传所有文件..."

# 创建临时目录
TEMP_DIR=$(mktemp -d)
cp ../../src/routes/admin.js "$TEMP_DIR/"
cp ../../src/routes/referralRoutes.js "$TEMP_DIR/"
cp ../../src/app.js "$TEMP_DIR/"

# 一次性上传所有文件到临时目录
sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no \
  "$TEMP_DIR/admin.js" \
  "$TEMP_DIR/referralRoutes.js" \
  "$TEMP_DIR/app.js" \
  "$SERVER:/tmp/" || error "上传文件失败"

# 清理本地临时目录
rm -rf "$TEMP_DIR"

success "所有文件上传完成"

log "⏳ 等待 15 秒..."
sleep 15

# ----------------------------------------------------------------------------
# 第 3 阶段：移动文件并重启服务
# ----------------------------------------------------------------------------
log "🔄 第 2 次 SSH：移动文件、停止旧进程并重启服务..."
ssh_run "cd $DIR && mv /tmp/admin.js src/routes/ && mv /tmp/referralRoutes.js src/routes/ && mv /tmp/app.js src/ && pkill -9 -f 'node.*app.js' 2>/dev/null || true && sleep 3 && npm run service:start" || warn "重启命令执行完成（可能有警告）"
success "重启命令已执行"

log "⏳ 等待服务初始化 (20秒)..."
sleep 20

# ----------------------------------------------------------------------------
# 第 4 阶段：验证服务状态
# ----------------------------------------------------------------------------
log "✅ 第 3 次 SSH：验证服务状态..."
ssh_run "pgrep -f 'node.*app.js' > /dev/null" || error "服务进程未运行"
success "进程运行中"

log "🏥 HTTP 健康检查..."
if curl -s "$API_BASE_URL/health" | grep -q '"status":"healthy"'; then
  success "健康检查通过"
else
  error "健康检查失败"
fi

# ----------------------------------------------------------------------------
# 完成
# ----------------------------------------------------------------------------
echo ""
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║          ✅ 部署成功！                                          ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""
echo "📊 部署信息："
echo "  • 服务器: $SERVER"
echo "  • 目录: $DIR"
echo "  • API 地址: $API_BASE_URL"
echo "  • 备份文件: backups/$BACKUP_NAME"
echo ""
echo "🔗 验证链接："
echo "  • 健康检查: $API_BASE_URL/health"
echo "  • 用户邀请接口: $API_BASE_URL/users/referral"
echo "  • 管理员邀请统计: $API_BASE_URL/admin/referral/stats"
echo ""

