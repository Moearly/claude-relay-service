# Claude Relay Service 部署完成文档

## ✅ 部署状态

**服务器**: 156.229.163.86  
**部署目录**: `/opt/claude-relay-service`  
**最初部署**: 2025-10-09  
**最新更新**: 2025-10-17 11:30 CST (商业化功能已部署)  
**服务状态**: ✅ 运行中  
**服务版本**: v1.1.164  
**进程PID**: 3995072  

---

## 🆕 最新更新 (2025-10-17)

### 部署完成内容

1. ✅ **MongoDB 已安装并运行** - 数据库服务正常
2. ✅ **用户注册/登录系统** - 测试通过
3. ✅ **API Key 权限管理** - Claude/Gemini 服务隔离
4. ✅ **订阅套餐系统** - API已部署
5. ✅ **卡密充值系统** - 后端就绪
6. ✅ **服务独立统计** - 功能已集成
7. ✅ **财务报表** - 管理API已部署

### 部署过程

- ✅ 停止旧服务
- ✅ 备份配置文件到 `/tmp/claude-backup-20251017`
- ✅ 上传代码 (4.5M)
- ✅ 清理磁盘空间 (释放440M日志)
- ✅ 安装MongoDB 6.0.26
- ✅ 安装依赖
- ✅ 启动服务
- ✅ 健康检查通过

### 测试结果

```bash
# 健康检查
✅ Status: healthy
✅ Redis: connected (7ms)
✅ MongoDB: connected
✅ Memory: 37MB/41MB

# 用户注册测试
✅ POST /users/register - 成功
✅ 返回token和用户信息
✅ 默认1000积分

# 订阅套餐API
✅ GET /users/subscription/plans - 正常
```

---

## 🔐 管理员账户

**用户名**: `cr_admin_3ba48c3b`  
**密码**: `D0vI06DB0VEOpOlM`  

**⚠️ 重要**: 请立即保存这些凭据！首次登录后建议修改密码。

凭据文件位置: `/opt/claude-relay-service/data/init.json`

---

## 📊 当前部署状态

### ✅ 已完成

1. ✅ Docker 已卸载（释放约 500MB 内存）
2. ✅ Node.js 18.20.8 已安装
3. ✅ Redis 6.0.16 已安装并运行
4. ✅ 项目代码已克隆
5. ✅ 环境变量已配置
6. ✅ 后端依赖已安装
7. ✅ 1GB Swap 空间已创建
8. ✅ 管理员账户已初始化
9. ✅ 服务已启动（进程 PID: 3846741）
10. ✅ 健康检查通过
11. ✅ **前端界面已构建并部署**（本地构建后上传）
12. ✅ Web 管理界面可访问

### 🎉 部署状态：**完全成功**

---

## 🚀 服务信息

### API 端点

| 端点类型 | URL | 状态 |
|---------|-----|------|
| **健康检查** | http://156.229.163.86:3000/health | ✅ 正常 |
| **API 端点** | http://156.229.163.86:3000/api/v1/messages | ✅ 可用 |
| **Claude 别名** | http://156.229.163.86:3000/claude/v1/messages | ✅ 可用 |
| **Gemini API** | http://156.229.163.86:3000/gemini/v1/messages | ✅ 可用 |
| **OpenAI 兼容** | http://156.229.163.86:3000/openai/v1/chat/completions | ✅ 可用 |
| **管理 API** | http://156.229.163.86:3000/admin/* | ✅ 可用 |
| **Web 管理界面** | http://156.229.163.86:3000/admin-next/ | ✅ **正常运行** |

### 服务管理命令

```bash
# SSH 登录服务器
ssh root@156.229.163.86

# 进入项目目录
cd /opt/claude-relay-service

# 查看服务状态
npm run service:status

# 查看日志
npm run service:logs

# 查看实时日志
npm run service:logs:follow

# 重启服务
npm run service:restart:daemon

# 停止服务
npm run service:stop

# 启动服务
npm run service:start:daemon
```

---

## 📝 配置文件

### 环境变量 (.env)

```bash
# 位置: /opt/claude-relay-service/.env

JWT_SECRET=claude_relay_jwt_secret_52f9d1891a3d25f11f21ec00763c5c7c
ENCRYPTION_KEY=d360eca73144a73f7517b014d061396d

REDIS_HOST=127.0.0.1
REDIS_PORT=6379
PORT=3000
HOST=0.0.0.0
NODE_ENV=production
```

### Redis 状态

```bash
# Redis 服务
systemctl status redis-server

# Redis 连接测试
redis-cli ping
# 应返回: PONG
```

---

## 🚀 快速部署/更新

### 方式1: 一键自动部署（推荐）

```bash
# 1. 进入项目目录
cd /home/leiyi/codeSpace/ApiRelay/claude-relay-service

# 2. 运行部署前测试（可选）
./test-deploy.sh

# 3. 执行自动部署
./deploy-to-server.sh
# 输入服务器密码后，脚本会自动完成所有步骤
```

**自动部署包含**:
- ✅ 停止服务
- ✅ 备份配置
- ✅ 上传代码
- ✅ 恢复配置
- ✅ 自动添加 `MONGODB_ENABLED=true`
- ✅ 安装依赖
- ✅ 启动服务
- ✅ 健康检查

### 方式2: 手动部署

参见 `DEPLOY.md` 的手动部署步骤。

---

## 🔧 前端构建（如需要）

### 方案1: 本地构建并上传（推荐）

```bash
# 在你的本地电脑（有足够内存）执行：

# 1. 进入项目前端目录
cd /home/leiyi/codeSpace/ApiRelay/claude-relay-service/web/admin-spa

# 2. 安装依赖
npm install

# 3. 构建前端
npm run build

# 4. 压缩构建产物
cd dist
tar -czf admin-spa-dist.tar.gz .

# 5. 上传到服务器
scp admin-spa-dist.tar.gz root@156.229.163.86:/tmp/

# 6. 在服务器上解压
ssh root@156.229.163.86 "cd /opt/claude-relay-service/web/admin-spa && \
    mkdir -p dist && \
    cd dist && \
    tar -xzf /tmp/admin-spa-dist.tar.gz && \
    rm /tmp/admin-spa-dist.tar.gz"

# 7. 重启服务使前端生效
ssh root@156.229.163.86 "cd /opt/claude-relay-service && npm run service:restart:daemon"
```

### 方案2: 使用官方 Docker 镜像中的前端文件

```bash
# 在服务器上执行：

# 1. 临时启动 Docker 容器提取前端文件
docker pull weishaw/claude-relay-service:latest
docker create --name temp-crs weishaw/claude-relay-service:latest
docker cp temp-crs:/app/web/admin-spa/dist /opt/claude-relay-service/web/admin-spa/
docker rm temp-crs

# 2. 重启服务
cd /opt/claude-relay-service && npm run service:restart:daemon
```

### 方案3: 升级服务器内存（推荐）

- 将服务器内存升级到至少 1GB
- 然后在服务器上直接构建

```bash
ssh root@156.229.163.86
cd /opt/claude-relay-service
npm run build:web
npm run service:restart:daemon
```

---

## 🎯 快速开始使用

### 1. 测试 API 是否正常

```bash
# 健康检查
curl http://156.229.163.86:3000/health

# 应返回类似:
{
  "status": "healthy",
  "service": "claude-relay-service",
  "version": "1.1.164",
  "components": {
    "redis": {"status": "healthy"},
    "logger": {"status": "healthy"}
  }
}
```

### 2. 通过 CLI 添加 Claude 账户

```bash
ssh root@156.229.163.86
cd /opt/claude-relay-service
npm run cli
```

### 3. 通过 API 创建 API Key

```bash
# 先登录获取 token
curl -X POST http://156.229.163.86:3000/admin/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "cr_admin_3ba48c3b",
    "password": "D0vI06DB0VEOpOlM"
  }'

# 使用返回的 token 创建 API Key
curl -X POST http://156.229.163.86:3000/admin/api-keys \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "name": "Test API Key",
    "description": "测试用途",
    "permissions": "all"
  }'
```

### 4. 使用 Claude Code CLI

```bash
# 在你的本地电脑设置环境变量
export ANTHROPIC_BASE_URL="http://156.229.163.86:3000/api/"
export ANTHROPIC_AUTH_TOKEN="你创建的API密钥"

# 使用 Claude Code
claude "Hello, can you help me?"
```

---

## 📊 系统资源监控

### 内存使用情况

```bash
ssh root@156.229.163.86 'free -h'

# 当前状态:
#               total        used        free      shared  buff/cache   available
# Mem:           475Mi       254Mi       113Mi       0.0Ki       107Mi       208Mi
# Swap:          1.0Gi          0B       1.0Gi
```

### 磁盘使用情况

```bash
ssh root@156.229.163.86 'df -h'

# 当前状态:
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/sda1       4.9G  3.3G  1.5G  69% /
```

### 服务进程状态

```bash
ssh root@156.229.163.86 'ps aux | grep node'
```

---

## 🔒 安全建议

### 1. 配置防火墙

```bash
ssh root@156.229.163.86

# 安装 ufw
apt-get install -y ufw

# 允许 SSH
ufw allow 22/tcp

# 允许 API 端口
ufw allow 3000/tcp

# 启用防火墙
ufw enable
```

### 2. 配置 Caddy 反向代理（推荐）

```bash
# 安装 Caddy
apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
apt update
apt install caddy

# 配置 Caddyfile (需要域名)
# 编辑 /etc/caddy/Caddyfile
your-domain.com {
    reverse_proxy 127.0.0.1:3000 {
        flush_interval -1
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# 启动 Caddy
systemctl start caddy
systemctl enable caddy
```

### 3. 修改默认管理员密码

完成前端构建后，登录 Web 界面修改密码。

---

## 📌 重要文件位置

| 文件/目录 | 路径 | 说明 |
|----------|------|------|
| **项目根目录** | `/opt/claude-relay-service` | 主程序 |
| **环境变量** | `/opt/claude-relay-service/.env` | 配置文件 |
| **日志目录** | `/opt/claude-relay-service/logs` | 所有日志 |
| **数据目录** | `/opt/claude-relay-service/data` | 初始化数据 |
| **管理员凭据** | `/opt/claude-relay-service/data/init.json` | 账号密码 |
| **服务日志** | `/opt/claude-relay-service/logs/service.log` | 服务运行日志 |
| **错误日志** | `/opt/claude-relay-service/logs/service-error.log` | 错误日志 |
| **PID 文件** | `/opt/claude-relay-service/claude-relay-service.pid` | 进程 ID |
| **Redis 数据** | `/var/lib/redis` | Redis 持久化数据 |
| **Swap 文件** | `/swapfile` | 1GB 交换空间 |

---

## 🆘 故障排查

### 服务无法启动

```bash
# 查看详细错误日志
ssh root@156.229.163.86 'cat /opt/claude-relay-service/logs/service-error.log'

# 检查端口是否被占用
ssh root@156.229.163.86 'netstat -tlnp | grep 3000'

# 检查 Redis 是否运行
ssh root@156.229.163.86 'systemctl status redis-server'

# 手动启动查看错误
ssh root@156.229.163.86 'cd /opt/claude-relay-service && npm start'
```

### Redis 连接失败

```bash
# 重启 Redis
ssh root@156.229.163.86 'systemctl restart redis-server'

# 测试 Redis
ssh root@156.229.163.86 'redis-cli ping'
```

### 内存不足

```bash
# 查看内存使用
ssh root@156.229.163.86 'free -h'

# 查看进程内存占用
ssh root@156.229.163.86 'ps aux --sort=-%mem | head -10'

# 重启服务释放内存
ssh root@156.229.163.86 'cd /opt/claude-relay-service && npm run service:restart:daemon'
```

---

## 📈 后续优化建议

### 1. 性能优化

- [ ] 升级服务器内存到至少 1GB（当前 475MB 太小）
- [ ] 配置 Nginx/Caddy 反向代理
- [ ] 启用 HTTPS（Let's Encrypt）
- [ ] 配置 Redis 持久化策略
- [ ] 设置日志轮转

### 2. 监控和告警

- [ ] 配置健康检查监控
- [ ] 设置内存/磁盘告警
- [ ] 日志分析和错误追踪
- [ ] 配置 Webhook 通知

### 3. 备份策略

```bash
# 定期备份脚本
ssh root@156.229.163.86 'cat > /opt/backup-claude-relay.sh << "EOF"
#!/bin/bash
BACKUP_DIR="/root/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份配置和数据
cd /opt/claude-relay-service
tar -czf $BACKUP_DIR/claude-relay-$DATE.tar.gz \
    .env \
    config/config.js \
    data/ \
    logs/

# 保留最近7天的备份
find $BACKUP_DIR -name "claude-relay-*.tar.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_DIR/claude-relay-$DATE.tar.gz"
EOF'

# 设置执行权限
ssh root@156.229.163.86 'chmod +x /opt/backup-claude-relay.sh'

# 添加到 crontab（每天凌晨2点备份）
ssh root@156.229.163.86 'echo "0 2 * * * /opt/backup-claude-relay.sh" | crontab -'
```

---

## 🔗 相关链接

- **项目仓库**: https://github.com/Wei-Shaw/claude-relay-service
- **技术文档**: `/home/leiyi/codeSpace/ApiRelay/claude-relay-service/项目实现原理分析.md`
- **官方文档**: https://github.com/Wei-Shaw/claude-relay-service/blob/main/README.md
- **Telegram 频道**: https://t.me/claude_relay_service

---

## ✅ 部署清单

- [x] 卸载 Docker 释放内存
- [x] 安装 Node.js 18
- [x] 安装 Redis 6
- [x] 克隆项目代码
- [x] 配置环境变量
- [x] 安装后端依赖
- [x] 创建 Swap 空间
- [x] 初始化管理员账户
- [x] 启动服务
- [x] 验证健康检查
- [x] **构建前端界面（已完成）**
- [ ] 配置反向代理（可选）
- [ ] 启用 HTTPS（可选）
- [ ] 设置定期备份（可选）

---

**部署人员**: AI Assistant  
**文档生成时间**: 2025-10-09  
**完成时间**: 2025-10-09 11:30 CST  
**服务版本**: v1.1.164

**🎉 部署已完全完成！现在可以访问 Web 管理界面进行配置和使用。**

