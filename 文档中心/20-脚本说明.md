# 📜 项目脚本说明

本文档详细说明了 `scripts/` 目录下所有脚本的功能和使用方法。

---

## 📋 脚本分类

### 🔧 管理脚本

#### `manage.js` / `manage.sh`
**功能**: 服务管理主脚本

**使用方法**:
```bash
# 启动服务
npm run service:start

# 后台启动
npm run service:start:daemon

# 停止服务
npm run service:stop

# 重启服务
npm run service:restart

# 查看状态
npm run service:status

# 查看日志
npm run service:logs

# 实时日志
npm run service:logs:follow
```

#### `setup.js`
**功能**: 项目初始化设置

**使用方法**:
```bash
npm run setup
```

**功能包括**:
- 环境检查
- 配置文件生成
- 依赖安装验证
- 目录结构创建

---

### 📊 监控脚本

#### `monitor-enhanced.sh`
**功能**: 增强版服务监控

**使用方法**:
```bash
npm run monitor

# 或直接执行
bash scripts/monitor-enhanced.sh
```

**监控内容**:
- 服务运行状态
- CPU 和内存使用
- Redis 连接状态
- MongoDB 连接状态
- 请求统计
- 错误日志分析

#### `status-unified.sh`
**功能**: 统一状态查看

**使用方法**:
```bash
npm run status

# 详细模式
npm run status:detail
```

**输出信息**:
- 服务基本信息
- 进程状态
- 端口占用
- 资源使用
- 日志摘要

---

### 🔑 账号管理脚本

#### `test-account-display.js`
**功能**: 测试账号显示

**使用方法**:
```bash
node scripts/test-account-display.js
```

#### `test-dedicated-accounts.js`
**功能**: 测试专用账号功能

**使用方法**:
```bash
node scripts/test-dedicated-accounts.js
```

---

### 🔍 Gemini 相关脚本

#### `check-gemini-status.sh`
**功能**: 检查 Gemini 服务状态

**使用方法**:
```bash
bash scripts/check-gemini-status.sh
```

#### `refresh-gemini-token.sh`
**功能**: 刷新 Gemini token

**使用方法**:
```bash
bash scripts/refresh-gemini-token.sh
```

#### `test-gemini-refresh.js`
**功能**: 测试 Gemini token 刷新

**使用方法**:
```bash
node scripts/test-gemini-refresh.js
```

---

### 💾 数据管理脚本

#### `data-transfer.js`
**功能**: 基础数据导入导出

**使用方法**:
```bash
# 导出数据
npm run data:export

# 导入数据
npm run data:import

# 导出脱敏数据
npm run data:export:sanitized
```

#### `data-transfer-enhanced.js`
**功能**: 增强版数据传输（支持加密）

**使用方法**:
```bash
# 导出数据
npm run data:export:enhanced

# 导出加密数据
npm run data:export:encrypted

# 导入数据
npm run data:import:enhanced
```

---

### 🗄️ Redis 相关脚本

#### `check-redis-keys.js`
**功能**: 检查 Redis 键值

**使用方法**:
```bash
node scripts/check-redis-keys.js [pattern]
```

示例:
```bash
node scripts/check-redis-keys.js "apikey:*"
```

#### `debug-redis-keys.js`
**功能**: Redis 调试工具

**使用方法**:
```bash
npm run data:debug
```

---

### 🔄 迁移脚本

#### `migrate-apikey-expiry.js`
**功能**: API 密钥过期时间迁移

**使用方法**:
```bash
# 预览（不实际执行）
npm run migrate:apikey-expiry:dry

# 执行迁移
npm run migrate:apikey-expiry
```

#### `fix-usage-stats.js`
**功能**: 修复使用统计数据

**使用方法**:
```bash
npm run migrate:fix-usage-stats
```

---

### 🧪 测试脚本

#### `test-api-response.js`
**功能**: 测试 API 响应

**使用方法**:
```bash
node scripts/test-api-response.js
```

#### `test-bedrock-models.js`
**功能**: 测试 AWS Bedrock 模型

**使用方法**:
```bash
node scripts/test-bedrock-models.js
```

#### `test-group-scheduling.js`
**功能**: 测试分组调度

**使用方法**:
```bash
node scripts/test-group-scheduling.js
```

#### `test-model-mapping.js`
**功能**: 测试模型映射

**使用方法**:
```bash
node scripts/test-model-mapping.js
```

#### `test-pricing-fallback.js`
**功能**: 测试价格回退机制

**使用方法**:
```bash
npm run test:pricing-fallback
```

#### `test-window-remaining.js`
**功能**: 测试窗口剩余

**使用方法**:
```bash
node scripts/test-window-remaining.js
```

#### `test-web-dist.sh`
**功能**: 测试 Web 构建产物

**使用方法**:
```bash
bash scripts/test-web-dist.sh
```

---

### 💰 定价脚本

#### `update-model-pricing.js`
**功能**: 更新模型价格

**使用方法**:
```bash
npm run update:pricing
```

**功能**:
- 从配置文件更新价格
- 同步到数据库
- 验证价格完整性

---

### 🗃️ 数据库脚本

#### `init-database.js`
**功能**: 初始化数据库

**使用方法**:
```bash
node scripts/init-database.js
```

**功能包括**:
- 创建集合
- 创建索引
- 初始化数据
- 权限配置

#### `generate-test-data.js`
**功能**: 生成测试数据

**使用方法**:
```bash
node scripts/generate-test-data.js
```

---

### 📈 日志分析脚本

#### `analyze-log-sessions.js`
**功能**: 分析日志会话

**使用方法**:
```bash
node scripts/analyze-log-sessions.js [log-file]
```

示例:
```bash
node scripts/analyze-log-sessions.js logs/app.log
```

---

### 🪟 会话窗口脚本

#### `manage-session-windows.js`
**功能**: 管理会话窗口

**使用方法**:
```bash
node scripts/manage-session-windows.js [command]
```

命令:
- `list` - 列出所有窗口
- `reset` - 重置窗口
- `clean` - 清理过期窗口

---

### 🛠️ 工具脚本

#### `fix-inquirer.js`
**功能**: 修复 Inquirer.js 兼容性问题

**使用方法**:
```bash
node scripts/fix-inquirer.js
```

---

## 📝 脚本开发规范

### 命名规范
- 使用小写字母和连字符
- 功能明确的命名
- 添加适当的后缀 (.js / .sh)

### 文件头注释
```javascript
/**
 * 脚本名称
 * 
 * 功能描述
 * 
 * 使用方法:
 *   node scripts/script-name.js [options]
 * 
 * 作者: 
 * 日期: 
 */
```

### 错误处理
- 使用 try-catch 捕获异常
- 提供清晰的错误信息
- 适当的退出码

### 日志输出
- 使用彩色输出
- 分级日志（INFO, WARN, ERROR）
- 进度提示

---

## 🔒 安全注意事项

### 敏感信息
- 不要在脚本中硬编码密码
- 使用环境变量
- 脱敏日志输出

### 权限管理
- 检查执行权限
- 验证用户身份
- 限制操作范围

### 数据备份
- 执行前备份
- 验证数据完整性
- 提供回滚机制

---

## 📚 相关文档

- [运维手册](./14-运维手册.md)
- [开发指南](./17-开发指南.md)
- [故障排查](./16-故障排查.md)

---

**最后更新**: 2025-10-22

