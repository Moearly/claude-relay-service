# 🖥️ 服务器配置脚本

本文档包含服务器配置和远程管理的脚本。

---

## 📋 服务器信息

**生产服务器**:
- **IP**: 156.229.163.86
- **用户**: root
- **部署目录**: /opt/claude-relay-service
- **服务端口**: 3000
- **Node版本**: >= 18.0.0

---

## 🔧 CORS 配置脚本

### 自动配置脚本

保存为 `scripts/configure-cors-remote.sh`:

```bash
#!/bin/bash

# 服务器信息
SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"
PROJECT_DIR="/opt/claude-relay-service"

echo "🔧 配置服务器 CORS..."

# 使用 sshpass 连接服务器
sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

# 备份配置
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# 删除旧的 CORS 配置
sed -i '/^CORS_ORIGIN=/d' .env

# 添加新的 CORS 配置
cat >> .env << EOF

# Frontend domains
CORS_ORIGIN=https://codewith.site,https://www.codewith.site
EOF

echo "✅ CORS 配置已更新"
cat .env | grep CORS_ORIGIN

# 重启服务
npm run service:restart

# 等待服务启动
sleep 5

# 检查状态
npm run service:status

ENDSSH

echo "✅ 配置完成！"
```

### 手动配置步骤

如果自动脚本无法使用，可以手动 SSH 配置：

```bash
# 1. 连接服务器
ssh root@156.229.163.86

# 2. 进入项目目录
cd /opt/claude-relay-service

# 3. 备份配置
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# 4. 编辑配置
vim .env
# 或
nano .env

# 5. 添加或更新以下行
CORS_ORIGIN=https://codewith.site,https://www.codewith.site

# 6. 保存并重启服务
npm run service:restart

# 7. 检查状态
npm run service:status

# 8. 查看日志
npm run service:logs:follow
```

---

## 🔍 健康检查脚本

### 本地测试脚本

保存为 `scripts/test-api-health.sh`:

```bash
#!/bin/bash

API_URL="https://api.codewith.site"

echo "🏥 测试 API 健康状态..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 测试健康检查
echo "1. 基础健康检查:"
curl -s "$API_URL/health" | jq '.'

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 测试详细健康检查
echo "2. 详细健康检查:"
curl -s "$API_URL/health/detailed" | jq '.'

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 测试 CORS
echo "3. 测试 CORS:"
curl -I -H "Origin: https://codewith.site" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: Content-Type,Authorization" \
     "$API_URL/v1/messages"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
```

---

## 📊 服务监控脚本

### 远程监控脚本

保存为 `scripts/monitor-remote.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"

echo "📊 远程服务监控"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

echo "🔹 服务状态:"
npm run service:status

echo ""
echo "🔹 系统资源:"
echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
echo "内存: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')"
echo "磁盘: $(df -h /opt | awk 'NR==2{print $5}')"

echo ""
echo "🔹 进程信息:"
ps aux | grep "node.*app.js" | grep -v grep

echo ""
echo "🔹 最近日志:"
tail -n 20 logs/app.log

ENDSSH

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
```

---

## 🔄 服务管理脚本

### 批量服务管理

保存为 `scripts/service-remote-manager.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"

# 使用方法: ./service-remote-manager.sh [start|stop|restart|status|logs]

ACTION=${1:-status}

echo "🔧 远程服务管理 - 操作: $ACTION"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << ENDSSH

cd /opt/claude-relay-service

case "$ACTION" in
    start)
        echo "▶️  启动服务..."
        npm run service:start:daemon
        ;;
    stop)
        echo "⏹️  停止服务..."
        npm run service:stop
        ;;
    restart)
        echo "🔄 重启服务..."
        npm run service:restart
        ;;
    status)
        echo "📊 服务状态..."
        npm run service:status
        ;;
    logs)
        echo "📜 查看日志..."
        npm run service:logs
        ;;
    *)
        echo "❌ 未知操作: $ACTION"
        echo "用法: $0 {start|stop|restart|status|logs}"
        exit 1
        ;;
esac

ENDSSH

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ 操作完成！"
```

---

## 📦 部署更新脚本

### 远程部署脚本

保存为 `scripts/deploy-remote.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"
LOCAL_PATH="."
REMOTE_PATH="/opt/claude-relay-service"

echo "🚀 部署更新到远程服务器"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 1. 打包本地代码
echo "📦 1. 打包本地代码..."
tar -czf deploy.tar.gz \
    --exclude=node_modules \
    --exclude=.git \
    --exclude=logs \
    --exclude=temp \
    --exclude=data \
    src config package.json

echo "✅ 打包完成: deploy.tar.gz"
echo ""

# 2. 上传到服务器
echo "📤 2. 上传到服务器..."
sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
    deploy.tar.gz "$SERVER_USER@$SERVER_IP:/tmp/"

echo "✅ 上传完成"
echo ""

# 3. 部署到服务器
echo "🔄 3. 部署到服务器..."
sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

# 停止服务
echo "⏹️  停止服务..."
npm run service:stop

# 备份
echo "💾 备份当前版本..."
BACKUP_DIR="/tmp/backup-$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp -r src config package.json "$BACKUP_DIR/"

# 解压新版本
echo "📦 解压新版本..."
tar -xzf /tmp/deploy.tar.gz -C /opt/claude-relay-service

# 安装依赖
echo "📥 安装依赖..."
npm install --production

# 启动服务
echo "▶️  启动服务..."
npm run service:start:daemon

# 等待启动
sleep 5

# 检查状态
echo "📊 检查状态..."
npm run service:status

echo ""
echo "✅ 部署完成！备份位置: $BACKUP_DIR"

ENDSSH

# 清理本地打包文件
rm -f deploy.tar.gz

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🎉 部署完成！"
```

---

## 🔐 安全配置

### SSH 密钥配置（推荐）

**步骤**:

1. **生成 SSH 密钥**:
```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

2. **复制公钥到服务器**:
```bash
ssh-copy-id root@156.229.163.86
```

3. **测试连接**:
```bash
ssh root@156.229.163.86
```

4. **更新脚本**（移除密码）:
```bash
# 替换
sshpass -p "$SERVER_PASS" ssh ...

# 为
ssh ...
```

### 防火墙配置

**在服务器上配置**:

```bash
# SSH 到服务器
ssh root@156.229.163.86

# 允许 SSH
ufw allow 22/tcp

# 允许 HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许服务端口（如果需要直接访问）
ufw allow 3000/tcp

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

---

## 📝 使用说明

### 创建脚本目录

```bash
mkdir -p /home/leiyi/codeSpace/ApiRelay/claude-relay-service/scripts/remote
```

### 保存脚本

将上述脚本保存到 `scripts/remote/` 目录，并添加执行权限：

```bash
chmod +x scripts/remote/*.sh
```

### 执行脚本

```bash
# 配置 CORS
bash scripts/remote/configure-cors-remote.sh

# 测试健康检查
bash scripts/remote/test-api-health.sh

# 远程监控
bash scripts/remote/monitor-remote.sh

# 服务管理
bash scripts/remote/service-remote-manager.sh restart

# 部署更新
bash scripts/remote/deploy-remote.sh
```

---

## 🆘 故障排查

### SSH 连接失败

**问题**: `kex_exchange_identification: Connection closed`

**可能原因**:
1. 防火墙阻止
2. SSH 服务未运行
3. 安全组配置
4. IP 被禁止

**解决方法**:
1. 检查服务器防火墙
2. 联系服务器管理员
3. 使用 VPN 连接
4. 使用密钥认证

### 服务启动失败

**检查步骤**:
```bash
# 查看日志
npm run service:logs

# 检查端口
netstat -tlnp | grep 3000

# 检查进程
ps aux | grep node

# 检查 Redis
redis-cli ping

# 检查 MongoDB
mongosh --eval "db.adminCommand('ping')"
```

---

## 📚 相关文档

- [运维手册](./14-运维手册.md)
- [部署指南](./05-部署指南.md)
- [脚本说明](./20-脚本说明.md)

---

**最后更新**: 2025-10-22
**服务器**: 156.229.163.86

