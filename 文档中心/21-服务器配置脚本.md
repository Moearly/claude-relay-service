# ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®è„šæœ¬

æœ¬æ–‡æ¡£åŒ…å«æœåŠ¡å™¨é…ç½®å’Œè¿œç¨‹ç®¡ç†çš„è„šæœ¬ã€‚

---

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯

**ç”Ÿäº§æœåŠ¡å™¨**:
- **IP**: 156.229.163.86
- **ç”¨æˆ·**: root
- **éƒ¨ç½²ç›®å½•**: /opt/claude-relay-service
- **æœåŠ¡ç«¯å£**: 3000
- **Nodeç‰ˆæœ¬**: >= 18.0.0

---

## ğŸ”§ CORS é…ç½®è„šæœ¬

### è‡ªåŠ¨é…ç½®è„šæœ¬

ä¿å­˜ä¸º `scripts/configure-cors-remote.sh`:

```bash
#!/bin/bash

# æœåŠ¡å™¨ä¿¡æ¯
SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"
PROJECT_DIR="/opt/claude-relay-service"

echo "ğŸ”§ é…ç½®æœåŠ¡å™¨ CORS..."

# ä½¿ç”¨ sshpass è¿æ¥æœåŠ¡å™¨
sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

# å¤‡ä»½é…ç½®
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# åˆ é™¤æ—§çš„ CORS é…ç½®
sed -i '/^CORS_ORIGIN=/d' .env

# æ·»åŠ æ–°çš„ CORS é…ç½®
cat >> .env << EOF

# Frontend domains
CORS_ORIGIN=https://codewith.site,https://www.codewith.site
EOF

echo "âœ… CORS é…ç½®å·²æ›´æ–°"
cat .env | grep CORS_ORIGIN

# é‡å¯æœåŠ¡
npm run service:restart

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 5

# æ£€æŸ¥çŠ¶æ€
npm run service:status

ENDSSH

echo "âœ… é…ç½®å®Œæˆï¼"
```

### æ‰‹åŠ¨é…ç½®æ­¥éª¤

å¦‚æœè‡ªåŠ¨è„šæœ¬æ— æ³•ä½¿ç”¨ï¼Œå¯ä»¥æ‰‹åŠ¨ SSH é…ç½®ï¼š

```bash
# 1. è¿æ¥æœåŠ¡å™¨
ssh root@156.229.163.86

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/claude-relay-service

# 3. å¤‡ä»½é…ç½®
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# 4. ç¼–è¾‘é…ç½®
vim .env
# æˆ–
nano .env

# 5. æ·»åŠ æˆ–æ›´æ–°ä»¥ä¸‹è¡Œ
CORS_ORIGIN=https://codewith.site,https://www.codewith.site

# 6. ä¿å­˜å¹¶é‡å¯æœåŠ¡
npm run service:restart

# 7. æ£€æŸ¥çŠ¶æ€
npm run service:status

# 8. æŸ¥çœ‹æ—¥å¿—
npm run service:logs:follow
```

---

## ğŸ” å¥åº·æ£€æŸ¥è„šæœ¬

### æœ¬åœ°æµ‹è¯•è„šæœ¬

ä¿å­˜ä¸º `scripts/test-api-health.sh`:

```bash
#!/bin/bash

API_URL="https://api.codewith.site"

echo "ğŸ¥ æµ‹è¯• API å¥åº·çŠ¶æ€..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æµ‹è¯•å¥åº·æ£€æŸ¥
echo "1. åŸºç¡€å¥åº·æ£€æŸ¥:"
curl -s "$API_URL/health" | jq '.'

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æµ‹è¯•è¯¦ç»†å¥åº·æ£€æŸ¥
echo "2. è¯¦ç»†å¥åº·æ£€æŸ¥:"
curl -s "$API_URL/health/detailed" | jq '.'

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æµ‹è¯• CORS
echo "3. æµ‹è¯• CORS:"
curl -I -H "Origin: https://codewith.site" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: Content-Type,Authorization" \
     "$API_URL/v1/messages"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
```

---

## ğŸ“Š æœåŠ¡ç›‘æ§è„šæœ¬

### è¿œç¨‹ç›‘æ§è„šæœ¬

ä¿å­˜ä¸º `scripts/monitor-remote.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"

echo "ğŸ“Š è¿œç¨‹æœåŠ¡ç›‘æ§"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

echo "ğŸ”¹ æœåŠ¡çŠ¶æ€:"
npm run service:status

echo ""
echo "ğŸ”¹ ç³»ç»Ÿèµ„æº:"
echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
echo "å†…å­˜: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2 }')"
echo "ç£ç›˜: $(df -h /opt | awk 'NR==2{print $5}')"

echo ""
echo "ğŸ”¹ è¿›ç¨‹ä¿¡æ¯:"
ps aux | grep "node.*app.js" | grep -v grep

echo ""
echo "ğŸ”¹ æœ€è¿‘æ—¥å¿—:"
tail -n 20 logs/app.log

ENDSSH

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
```

---

## ğŸ”„ æœåŠ¡ç®¡ç†è„šæœ¬

### æ‰¹é‡æœåŠ¡ç®¡ç†

ä¿å­˜ä¸º `scripts/service-remote-manager.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"

# ä½¿ç”¨æ–¹æ³•: ./service-remote-manager.sh [start|stop|restart|status|logs]

ACTION=${1:-status}

echo "ğŸ”§ è¿œç¨‹æœåŠ¡ç®¡ç† - æ“ä½œ: $ACTION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << ENDSSH

cd /opt/claude-relay-service

case "$ACTION" in
    start)
        echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
        npm run service:start:daemon
        ;;
    stop)
        echo "â¹ï¸  åœæ­¢æœåŠ¡..."
        npm run service:stop
        ;;
    restart)
        echo "ğŸ”„ é‡å¯æœåŠ¡..."
        npm run service:restart
        ;;
    status)
        echo "ğŸ“Š æœåŠ¡çŠ¶æ€..."
        npm run service:status
        ;;
    logs)
        echo "ğŸ“œ æŸ¥çœ‹æ—¥å¿—..."
        npm run service:logs
        ;;
    *)
        echo "âŒ æœªçŸ¥æ“ä½œ: $ACTION"
        echo "ç”¨æ³•: $0 {start|stop|restart|status|logs}"
        exit 1
        ;;
esac

ENDSSH

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… æ“ä½œå®Œæˆï¼"
```

---

## ğŸ“¦ éƒ¨ç½²æ›´æ–°è„šæœ¬

### è¿œç¨‹éƒ¨ç½²è„šæœ¬

ä¿å­˜ä¸º `scripts/deploy-remote.sh`:

```bash
#!/bin/bash

SERVER_IP="156.229.163.86"
SERVER_USER="root"
SERVER_PASS="jR74pQyDMTRt*eti7@"
LOCAL_PATH="."
REMOTE_PATH="/opt/claude-relay-service"

echo "ğŸš€ éƒ¨ç½²æ›´æ–°åˆ°è¿œç¨‹æœåŠ¡å™¨"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. æ‰“åŒ…æœ¬åœ°ä»£ç 
echo "ğŸ“¦ 1. æ‰“åŒ…æœ¬åœ°ä»£ç ..."
tar -czf deploy.tar.gz \
    --exclude=node_modules \
    --exclude=.git \
    --exclude=logs \
    --exclude=temp \
    --exclude=data \
    src config package.json

echo "âœ… æ‰“åŒ…å®Œæˆ: deploy.tar.gz"
echo ""

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
echo "ğŸ“¤ 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨..."
sshpass -p "$SERVER_PASS" scp -o StrictHostKeyChecking=no \
    deploy.tar.gz "$SERVER_USER@$SERVER_IP:/tmp/"

echo "âœ… ä¸Šä¼ å®Œæˆ"
echo ""

# 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
echo "ğŸ”„ 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_IP" bash << 'ENDSSH'

cd /opt/claude-relay-service

# åœæ­¢æœåŠ¡
echo "â¹ï¸  åœæ­¢æœåŠ¡..."
npm run service:stop

# å¤‡ä»½
echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
BACKUP_DIR="/tmp/backup-$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp -r src config package.json "$BACKUP_DIR/"

# è§£å‹æ–°ç‰ˆæœ¬
echo "ğŸ“¦ è§£å‹æ–°ç‰ˆæœ¬..."
tar -xzf /tmp/deploy.tar.gz -C /opt/claude-relay-service

# å®‰è£…ä¾èµ–
echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
npm install --production

# å¯åŠ¨æœåŠ¡
echo "â–¶ï¸  å¯åŠ¨æœåŠ¡..."
npm run service:start:daemon

# ç­‰å¾…å¯åŠ¨
sleep 5

# æ£€æŸ¥çŠ¶æ€
echo "ğŸ“Š æ£€æŸ¥çŠ¶æ€..."
npm run service:status

echo ""
echo "âœ… éƒ¨ç½²å®Œæˆï¼å¤‡ä»½ä½ç½®: $BACKUP_DIR"

ENDSSH

# æ¸…ç†æœ¬åœ°æ‰“åŒ…æ–‡ä»¶
rm -f deploy.tar.gz

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
```

---

## ğŸ” å®‰å…¨é…ç½®

### SSH å¯†é’¥é…ç½®ï¼ˆæ¨èï¼‰

**æ­¥éª¤**:

1. **ç”Ÿæˆ SSH å¯†é’¥**:
```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

2. **å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨**:
```bash
ssh-copy-id root@156.229.163.86
```

3. **æµ‹è¯•è¿æ¥**:
```bash
ssh root@156.229.163.86
```

4. **æ›´æ–°è„šæœ¬**ï¼ˆç§»é™¤å¯†ç ï¼‰:
```bash
# æ›¿æ¢
sshpass -p "$SERVER_PASS" ssh ...

# ä¸º
ssh ...
```

### é˜²ç«å¢™é…ç½®

**åœ¨æœåŠ¡å™¨ä¸Šé…ç½®**:

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@156.229.163.86

# å…è®¸ SSH
ufw allow 22/tcp

# å…è®¸ HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# å…è®¸æœåŠ¡ç«¯å£ï¼ˆå¦‚æœéœ€è¦ç›´æ¥è®¿é—®ï¼‰
ufw allow 3000/tcp

# å¯ç”¨é˜²ç«å¢™
ufw enable

# æŸ¥çœ‹çŠ¶æ€
ufw status
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### åˆ›å»ºè„šæœ¬ç›®å½•

```bash
mkdir -p /home/leiyi/codeSpace/ApiRelay/claude-relay-service/scripts/remote
```

### ä¿å­˜è„šæœ¬

å°†ä¸Šè¿°è„šæœ¬ä¿å­˜åˆ° `scripts/remote/` ç›®å½•ï¼Œå¹¶æ·»åŠ æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x scripts/remote/*.sh
```

### æ‰§è¡Œè„šæœ¬

```bash
# é…ç½® CORS
bash scripts/remote/configure-cors-remote.sh

# æµ‹è¯•å¥åº·æ£€æŸ¥
bash scripts/remote/test-api-health.sh

# è¿œç¨‹ç›‘æ§
bash scripts/remote/monitor-remote.sh

# æœåŠ¡ç®¡ç†
bash scripts/remote/service-remote-manager.sh restart

# éƒ¨ç½²æ›´æ–°
bash scripts/remote/deploy-remote.sh
```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### SSH è¿æ¥å¤±è´¥

**é—®é¢˜**: `kex_exchange_identification: Connection closed`

**å¯èƒ½åŸå› **:
1. é˜²ç«å¢™é˜»æ­¢
2. SSH æœåŠ¡æœªè¿è¡Œ
3. å®‰å…¨ç»„é…ç½®
4. IP è¢«ç¦æ­¢

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™
2. è”ç³»æœåŠ¡å™¨ç®¡ç†å‘˜
3. ä½¿ç”¨ VPN è¿æ¥
4. ä½¿ç”¨å¯†é’¥è®¤è¯

### æœåŠ¡å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ­¥éª¤**:
```bash
# æŸ¥çœ‹æ—¥å¿—
npm run service:logs

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 3000

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node

# æ£€æŸ¥ Redis
redis-cli ping

# æ£€æŸ¥ MongoDB
mongosh --eval "db.adminCommand('ping')"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¿ç»´æ‰‹å†Œ](./14-è¿ç»´æ‰‹å†Œ.md)
- [éƒ¨ç½²æŒ‡å—](./05-éƒ¨ç½²æŒ‡å—.md)
- [è„šæœ¬è¯´æ˜](./20-è„šæœ¬è¯´æ˜.md)

---

**æœ€åæ›´æ–°**: 2025-10-22
**æœåŠ¡å™¨**: 156.229.163.86

