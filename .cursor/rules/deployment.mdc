---
description: Deployment procedures and server management
---

# éƒ¨ç½²å’ŒæœåŠ¡å™¨ç®¡ç†

## æœåŠ¡å™¨ä¿¡æ¯

### ç”Ÿäº§æœåŠ¡å™¨
- **IP**: 156.229.163.86
- **ç”¨æˆ·**: root
- **å¯†ç **: jR74pQyDMTRt*eti7@
- **éƒ¨ç½²ç›®å½•**: /opt/claude-relay-service
- **API åœ°å€**: https://api.codewith.site
- **SSH è¿æ¥**: `sshpass -p 'jR74pQyDMTRt*eti7@' ssh -o StrictHostKeyChecking=no root@156.229.163.86`

## ğŸš€ æ¨èéƒ¨ç½²æ–¹å¼ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

### ä¸€é”®éƒ¨ç½²ï¼ˆå¼ºçƒˆæ¨èï¼‰
```bash
cd /home/leiyi/codeSpace/ApiRelay/claude-relay-service

# æ ‡å‡†éƒ¨ç½²ï¼ˆè‡ªåŠ¨æ£€æŸ¥ã€å¤‡ä»½ã€ä¸Šä¼ ã€é‡å¯ã€éªŒè¯ï¼‰
./scripts/deploy.sh

# å¼ºåˆ¶é‡æ–°å®‰è£…ä¾èµ–
./scripts/deploy.sh --force
```

**è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ä¼šæ‰§è¡Œ**:
1. âœ… æ£€æŸ¥æœ¬åœ°ç¯å¢ƒï¼ˆgit, node, npm, sshpassï¼‰
2. âœ… æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒï¼ˆè¿æ¥ã€ç›®å½•ã€é…ç½®ï¼‰
3. âœ… å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆä¿å­˜åˆ° backups/ ç›®å½•ï¼‰
4. âœ… ä¸Šä¼ ä»£ç æ–‡ä»¶
5. âœ… å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
6. âœ… åœæ­¢æ—§æœåŠ¡ï¼ˆè‡ªåŠ¨å¤„ç†ç«¯å£å ç”¨ï¼‰
7. âœ… å¯åŠ¨æ–°æœåŠ¡
8. âœ… å¥åº·æ£€æŸ¥ï¼ˆé‡è¯• 5 æ¬¡ï¼‰
9. âœ… è¿è¡Œ API æµ‹è¯•
10. âœ… æ£€æŸ¥é”™è¯¯æ—¥å¿—

### éƒ¨ç½²å‰æ£€æŸ¥
```bash
# æ£€æŸ¥ç¯å¢ƒé…ç½®æ˜¯å¦å®Œæ•´
./scripts/check-env.sh

# æœ¬åœ°è¿è¡Œ API æµ‹è¯•
export ADMIN_TOKEN="your-admin-token"
node scripts/test-api.js
```

## æ‰‹åŠ¨éƒ¨ç½²æ–¹å¼ï¼ˆä¸æ¨èï¼‰

### æ–¹å¼ 1: ç›´æ¥ä¸Šä¼ æ–‡ä»¶
```bash
# ä¸Šä¼ å•ä¸ªæ–‡ä»¶
sshpass -p 'jR74pQyDMTRt*eti7@' scp -o StrictHostKeyChecking=no \
  /local/path/file.js \
  root@156.229.163.86:/opt/claude-relay-service/path/file.js

# é‡å¯æœåŠ¡
sshpass -p 'jR74pQyDMTRt*eti7@' ssh -o StrictHostKeyChecking=no \
  root@156.229.163.86 \
  "cd /opt/claude-relay-service && npm run service:restart"
```

### æ–¹å¼ 2: Git æ‹‰å–ï¼ˆå¦‚æœé…ç½®äº† Gitï¼‰
```bash
sshpass -p 'jR74pQyDMTRt*eti7@' ssh -o StrictHostKeyChecking=no \
  root@156.229.163.86 \
  "cd /opt/claude-relay-service && git pull && npm run service:restart"
```

**âš ï¸ æ‰‹åŠ¨éƒ¨ç½²çš„é—®é¢˜**:
- å®¹æ˜“é—æ¼æ–‡ä»¶
- æ²¡æœ‰è‡ªåŠ¨å¤‡ä»½
- æ²¡æœ‰å¥åº·æ£€æŸ¥
- ç«¯å£å ç”¨éœ€è¦æ‰‹åŠ¨å¤„ç†
- æ— æ³•éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ

### æœåŠ¡ç®¡ç†å‘½ä»¤
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /opt/claude-relay-service

# å¯åŠ¨æœåŠ¡
npm run service:start:daemon

# åœæ­¢æœåŠ¡
npm run service:stop

# é‡å¯æœåŠ¡
npm run service:restart

# æŸ¥çœ‹çŠ¶æ€
npm run service:status

# æŸ¥çœ‹æ—¥å¿—
npm run service:logs

# å®æ—¶æ—¥å¿—
npm run service:logs:follow
```

### æ£€æŸ¥æœåŠ¡è¿›ç¨‹
```bash
# æŸ¥çœ‹ Node è¿›ç¨‹
ps aux | grep 'node.*app.js' | grep -v grep

# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 3000

# æ€æ‰è¿›ç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
pkill -f 'node.*app.js'
```

## å‰ç«¯éƒ¨ç½²æµç¨‹

### Vercel éƒ¨ç½²
```bash
cd commercial-website

# 1. æœ¬åœ°æ„å»ºæµ‹è¯•
npm run build

# 2. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npx vercel --prod --yes

# 3. æŸ¥çœ‹éƒ¨ç½²ç»“æœ
# è¾“å‡ºä¼šæ˜¾ç¤º Production URLï¼Œä¾‹å¦‚ï¼š
# Production: https://commercial-website-xxx.vercel.app
```

### éƒ¨ç½²éªŒè¯
éƒ¨ç½²å®Œæˆåï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
1. è®¿é—®ç”Ÿäº§ URLï¼Œç¡®è®¤é¡µé¢æ­£å¸¸åŠ è½½
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼Œç¡®è®¤æ²¡æœ‰é”™è¯¯
3. æµ‹è¯•å…³é”®åŠŸèƒ½ï¼ˆç™»å½•ã€API è°ƒç”¨ç­‰ï¼‰

### å¸¸è§éƒ¨ç½²é—®é¢˜

#### æ„å»ºå¤±è´¥
```bash
# æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—
npm run build 2>&1 | tail -50

# æ£€æŸ¥ TypeScript é”™è¯¯
npm run build 2>&1 | grep "Type error"
```

#### éƒ¨ç½²å 404
- æ£€æŸ¥ Vercel é¡¹ç›®è®¾ç½®ä¸­çš„ Framework Preset æ˜¯å¦ä¸º "Next.js"
- ç¡®è®¤ `next.config.js` é…ç½®æ­£ç¡®

#### API è°ƒç”¨å¤±è´¥
- æ£€æŸ¥ `NEXT_PUBLIC_API_BASE_URL` ç¯å¢ƒå˜é‡
- ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ CORS é…ç½®

## ç¯å¢ƒå˜é‡ç®¡ç†

### åç«¯ç¯å¢ƒå˜é‡
æ–‡ä»¶ä½ç½®: `/opt/claude-relay-service/.env`

å…³é”®å˜é‡ï¼š
```bash
PORT=3000
CORS_ORIGIN=https://codewith.site,https://www.codewith.site
MONGODB_URI=mongodb://...
REDIS_URL=redis://...
```

### å‰ç«¯ç¯å¢ƒå˜é‡
åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­é…ç½®ï¼š
- `NEXT_PUBLIC_API_BASE_URL=https://api.codewith.site`

## ğŸ“‹ æ—¥å¿—ç®¡ç†

### ä½¿ç”¨æ—¥å¿—æŸ¥çœ‹å·¥å…·ï¼ˆæ¨èï¼‰
```bash
# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œæ—¥å¿—
./scripts/view-logs.sh

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
./scripts/view-logs.sh -f

# åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
./scripts/view-logs.sh -e

# æ˜¾ç¤ºæœ€å 100 è¡Œ
./scripts/view-logs.sh -n 100

# æœç´¢åŒ…å« "MongoDB" çš„æ—¥å¿—
./scripts/view-logs.sh -s "MongoDB"

# ç»„åˆä½¿ç”¨ï¼šå®æ—¶è·Ÿè¸ªé”™è¯¯
./scripts/view-logs.sh -f -e
```

### æ‰‹åŠ¨æŸ¥çœ‹æ—¥å¿—
```bash
# SSH åˆ°æœåŠ¡å™¨
sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86

cd /opt/claude-relay-service

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
tail -100 logs/service.log

# æŸ¥çœ‹è¯·æ±‚æ—¥å¿—ï¼ˆè¯¦ç»†ï¼‰
tail -100 logs/requests.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -100 logs/error.log

# å®æ—¶æ—¥å¿—
tail -f logs/service.log

# æœç´¢é”™è¯¯
grep -i error logs/service.log | tail -50
```

### æ—¥å¿—æ–‡ä»¶è¯´æ˜
- `logs/service.log` - ä¸»æœåŠ¡æ—¥å¿—
- `logs/requests.log` - è¯¦ç»†çš„è¯·æ±‚/å“åº”æ—¥å¿—ï¼ˆåŒ…å« requestIdï¼‰
- `logs/error.log` - é”™è¯¯æ—¥å¿—
- `logs/access.log` - è®¿é—®æ—¥å¿—

### å‰ç«¯æ—¥å¿—
åœ¨ Vercel é¡¹ç›®é¡µé¢æŸ¥çœ‹ï¼š
1. è®¿é—® Vercel Dashboard
2. é€‰æ‹©é¡¹ç›®
3. ç‚¹å‡» "Deployments"
4. é€‰æ‹©éƒ¨ç½²è®°å½•
5. æŸ¥çœ‹ "Build Logs" å’Œ "Function Logs"

## å›æ»šç­–ç•¥

### åç«¯å›æ»š
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@156.229.163.86

cd /opt/claude-relay-service

# æŸ¥çœ‹å¤‡ä»½
ls -la /tmp/backup-*

# æ¢å¤å¤‡ä»½
cp -r /tmp/backup-YYYYMMDD_HHMMSS/* .

# é‡å¯æœåŠ¡
npm run service:restart
```

### å‰ç«¯å›æ»š
åœ¨ Vercel Dashboard ä¸­ï¼š
1. æ‰¾åˆ°ä¹‹å‰çš„æˆåŠŸéƒ¨ç½²
2. ç‚¹å‡» "..." èœå•
3. é€‰æ‹© "Promote to Production"

## ç›‘æ§å’Œå‘Šè­¦

### å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥åç«¯ API
curl https://api.codewith.site/health

# æ£€æŸ¥å‰ç«¯
curl https://codewith.site
```

### æœåŠ¡å™¨èµ„æºç›‘æ§
```bash
# CPU å’Œå†…å­˜
top

# ç£ç›˜ç©ºé—´
df -h

# è¿›ç¨‹çŠ¶æ€
ps aux | grep node
```
