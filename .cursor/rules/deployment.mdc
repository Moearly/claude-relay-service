---
description: åç«¯éƒ¨ç½²æµç¨‹å’Œæœ€ä½³å®è·µ
---

# åç«¯éƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ¨èæ–¹å¼ï¼šä½¿ç”¨ä¼˜åŒ–éƒ¨ç½²è„šæœ¬

```bash
cd /home/leiyi/codeSpace/ApiRelay/claude-relay-service
./scripts/deploy-optimized.sh
```

**ç‰¹ç‚¹**ï¼š
- âœ… åªéœ€ 3 æ¬¡ SSH è¿æ¥ï¼ˆé¿å…é¢‘ç‡é™åˆ¶ï¼‰
- âœ… è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬
- âœ… è‡ªåŠ¨ä¸Šä¼ ä»£ç æ–‡ä»¶
- âœ… è‡ªåŠ¨é‡å¯æœåŠ¡
- âœ… å¥åº·æ£€æŸ¥éªŒè¯
- â±ï¸ çº¦ 2 åˆ†é’Ÿå®Œæˆ

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥

### 1. æ£€æŸ¥ä»£ç çŠ¶æ€
```bash
cd claude-relay-service
git status

# å¦‚æœ‰æœªæäº¤çš„æ›´æ”¹
git add .
git commit -m "your message"
```

### 2. æœ¬åœ°æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
```bash
# ä»£ç æ£€æŸ¥
npm run lint

# è¿è¡Œæµ‹è¯•
export ADMIN_TOKEN="your-token"
node scripts/test-api.js
```

---

## ğŸ”„ éƒ¨ç½²æµç¨‹è¯¦è§£

### éƒ¨ç½²è„šæœ¬æ‰§è¡Œæ­¥éª¤

1. **ç¬¬ 1 æ¬¡ SSH**ï¼šæµ‹è¯•è¿æ¥ + å¤‡ä»½
   ```bash
   # è¿æ¥æœåŠ¡å™¨å¹¶å¤‡ä»½å½“å‰ç‰ˆæœ¬
   ssh "cd /opt/claude-relay-service && tar -czf backups/backup_*.tar.gz src/routes/admin.js"
   sleep 15  # ç­‰å¾…é¿å…é¢‘ç‡é™åˆ¶
   ```

2. **SCP ä¸Šä¼ **ï¼šä¸Šä¼ ä»£ç æ–‡ä»¶
   ```bash
   # ä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶
   scp src/routes/admin.js root@156.229.163.86:/opt/claude-relay-service/src/routes/admin.js
   sleep 15
   ```

3. **ç¬¬ 2 æ¬¡ SSH**ï¼šé‡å¯æœåŠ¡
   ```bash
   # é‡å¯æœåŠ¡
   ssh "cd /opt/claude-relay-service && npm run service:restart"
   sleep 20  # ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
   ```

4. **ç¬¬ 3 æ¬¡ SSH**ï¼šéªŒè¯çŠ¶æ€
   ```bash
   # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿è¡Œ
   ssh "pgrep -f 'node.*app.js'"
   ```

5. **HTTP å¥åº·æ£€æŸ¥**
   ```bash
   # éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€
   curl https://api.codewith.site/health
   ```

---

## âœ… éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨è„šæœ¬
./scripts/check-env.sh

# æ–¹å¼ 2ï¼šç›´æ¥æ£€æŸ¥
curl https://api.codewith.site/health
```

**æœŸæœ›è¾“å‡º**ï¼š
```json
{
  "status": "healthy",
  "service": "claude-relay-service",
  "version": "1.1.182",
  "components": {
    "redis": {"status": "healthy"},
    "logger": {"status": "healthy"}
  }
}
```

### 2. æµ‹è¯•æ–°å¢çš„ API
```bash
# è¿è¡Œå®Œæ•´ API æµ‹è¯•
export ADMIN_TOKEN="your-admin-token"
node scripts/test-api.js
```

### 3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
./scripts/view-logs.sh -e -n 50

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
./scripts/view-logs.sh -f
```

### 4. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@156.229.163.86

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep 'node.*app.js'

# æŸ¥çœ‹ç«¯å£
netstat -tlnp | grep 3000
```

---

## ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤

### åŸºæœ¬æ“ä½œ
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@156.229.163.86
cd /opt/claude-relay-service

# å¯åŠ¨æœåŠ¡
npm run service:start:daemon

# åœæ­¢æœåŠ¡
npm run service:stop

# é‡å¯æœåŠ¡
npm run service:restart

# æŸ¥çœ‹çŠ¶æ€
npm run service:status

# æŸ¥çœ‹æ—¥å¿—
npm run service:logs

# å®æ—¶æ—¥å¿—
npm run service:logs:follow
```

### æ‰‹åŠ¨æ“ä½œï¼ˆä¸æ¨èï¼‰
```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep 'node.*app.js'

# æ€æ‰è¿›ç¨‹
pkill -9 -f 'node.*app.js'

# æ¸…ç†ç«¯å£
lsof -ti:3000 | xargs kill -9

# å¯åŠ¨æœåŠ¡
cd /opt/claude-relay-service
nohup npm run service:start:daemon &
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. SSH è¿æ¥å¤±è´¥
**åŸå› **ï¼šæœåŠ¡å™¨å¯¹ SSH è¿æ¥é¢‘ç‡æœ‰é™åˆ¶

**è§£å†³**ï¼š
```bash
# ç­‰å¾… 1-2 åˆ†é’Ÿåé‡è¯•
sleep 120
./scripts/deploy-optimized.sh
```

### 2. ç«¯å£è¢«å ç”¨
**é”™è¯¯**ï¼š`EADDRINUSE: address already in use 0.0.0.0:3000`

**è§£å†³**ï¼š
```bash
# éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†
# æˆ–æ‰‹åŠ¨æ¸…ç†
ssh root@156.229.163.86 "pkill -9 -f 'node.*app.js'; lsof -ti:3000 | xargs kill -9"
```

### 3. å¥åº·æ£€æŸ¥å¤±è´¥
**åŸå› **ï¼šæœåŠ¡åˆå§‹åŒ–éœ€è¦æ—¶é—´

**è§£å†³**ï¼š
```bash
# ç­‰å¾…æ›´é•¿æ—¶é—´
sleep 30

# æ‰‹åŠ¨æ£€æŸ¥
curl https://api.codewith.site/health

# æŸ¥çœ‹æ—¥å¿—
./scripts/view-logs.sh -e
```

### 4. æ–‡ä»¶ä¸Šä¼ å¤±è´¥
**åŸå› **ï¼šSSH è¿æ¥æ–­å¼€

**è§£å†³**ï¼š
```bash
# ç­‰å¾…åé‡è¯•
sleep 60
./scripts/deploy-optimized.sh
```

---

## ğŸ”„ å›æ»šæ“ä½œ

### è‡ªåŠ¨å›æ»š
éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½ï¼Œå¤±è´¥æ—¶è¯¢é—®æ˜¯å¦å›æ»š

### æ‰‹åŠ¨å›æ»š
```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@156.229.163.86
cd /opt/claude-relay-service

# æŸ¥çœ‹å¤‡ä»½
ls -lh backups/

# æ¢å¤å¤‡ä»½
tar -xzf backups/backup_YYYYMMDD_HHMMSS.tar.gz

# é‡å¯æœåŠ¡
npm run service:restart
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹æ—¥å¿—
```bash
# ä½¿ç”¨æ—¥å¿—å·¥å…·ï¼ˆæ¨èï¼‰
./scripts/view-logs.sh -f -e

# æ‰‹åŠ¨æŸ¥çœ‹
ssh root@156.229.163.86 "tail -f /opt/claude-relay-service/logs/*.log"
```

### æ—¥å¿—æ–‡ä»¶ä½ç½®
- `logs/service.log` - ä¸»æœåŠ¡æ—¥å¿—
- `logs/requests.log` - è¯·æ±‚æ—¥å¿—
- `logs/error.log` - é”™è¯¯æ—¥å¿—
- `logs/access.log` - è®¿é—®æ—¥å¿—

### ç›‘æ§æŒ‡æ ‡
```bash
# æŸ¥çœ‹æœåŠ¡å™¨èµ„æº
ssh root@156.229.163.86 "top -n 1 | head -20"

# æŸ¥çœ‹ç£ç›˜ç©ºé—´
ssh root@156.229.163.86 "df -h"

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
ssh root@156.229.163.86 "free -h"
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ä¼˜åŒ–çš„éƒ¨ç½²è„šæœ¬
- âœ… ä½¿ç”¨ `deploy-optimized.sh`
- âŒ é¿å…ä½¿ç”¨ `deploy.sh`ï¼ˆSSH è¿æ¥è¿‡å¤šï¼‰

### 2. éƒ¨ç½²å‰å‡†å¤‡
- âœ… æäº¤ä»£ç åˆ° Git
- âœ… æœ¬åœ°æµ‹è¯•é€šè¿‡
- âœ… æ£€æŸ¥ç¯å¢ƒé…ç½®

### 3. éƒ¨ç½²åéªŒè¯
- âœ… è¿è¡Œå¥åº·æ£€æŸ¥
- âœ… è¿è¡Œ API æµ‹è¯•
- âœ… æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- âœ… æµ‹è¯•å…³é”®åŠŸèƒ½

### 4. å®šæœŸç»´æŠ¤
- âœ… å®šæœŸæŸ¥çœ‹æ—¥å¿—
- âœ… ç›‘æ§æœåŠ¡å™¨èµ„æº
- âœ… æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶
- âœ… æ›´æ–°ä¾èµ–åŒ…

### 5. å®‰å…¨æ³¨æ„
- âš ï¸ ä¸è¦åœ¨å…¬å¼€ä»“åº“æäº¤å¯†ç 
- âš ï¸ å®šæœŸæ›´æ¢æœåŠ¡å™¨å¯†ç 
- âš ï¸ ä½¿ç”¨ SSH å¯†é’¥è®¤è¯ï¼ˆæ¨èï¼‰
- âš ï¸ é™åˆ¶ SSH è®¿é—® IP

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] ä»£ç å·²æäº¤åˆ° Git
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] æ²¡æœ‰ Lint é”™è¯¯
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å¤‡ä»½é‡è¦æ•°æ®

### éƒ¨ç½²ä¸­
- [ ] éƒ¨ç½²è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] æ–‡ä»¶ä¸Šä¼ å®Œæˆ
- [ ] æœåŠ¡é‡å¯æˆåŠŸ
- [ ] è¿›ç¨‹è¿è¡Œæ­£å¸¸

### éƒ¨ç½²å
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] API æµ‹è¯•é€šè¿‡
- [ ] æ²¡æœ‰é”™è¯¯æ—¥å¿—
- [ ] å‰ç«¯åŠŸèƒ½æ­£å¸¸
- [ ] å…³é”®åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿéƒ¨ç½²æŒ‡å—](../../../QUICK_DEPLOY.md)
- [éƒ¨ç½²æ€»ç»“](../../../DEPLOYMENT_SUMMARY.md)
- [è„šæœ¬è¯´æ˜](../../scripts/README.md)
- [æ•…éšœæ’æŸ¥](../../../commercial-website/.cursor/rules/troubleshooting.mdc)

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

### æŸ¥çœ‹æ—¥å¿—
```bash
./scripts/view-logs.sh -e -n 100
```

### æ£€æŸ¥ç¯å¢ƒ
```bash
./scripts/check-env.sh
```

### è¿è¡Œæµ‹è¯•
```bash
export ADMIN_TOKEN="your-token"
node scripts/test-api.js
```

### é‡æ–°éƒ¨ç½²
```bash
./scripts/deploy-optimized.sh
```
