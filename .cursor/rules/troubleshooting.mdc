---
description: Common issues and troubleshooting guide
---

# æ•…éšœæ’æŸ¥æŒ‡å—

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. SSH è¿æ¥å¤±è´¥

**é”™è¯¯**: `kex_exchange_identification: Connection closed`

**å¯èƒ½åŸå› **:
- è¿æ¥é¢‘ç‡è¿‡é«˜è¢«æœåŠ¡å™¨é™åˆ¶
- é˜²ç«å¢™é˜»æ­¢
- SSH æœåŠ¡é…ç½®é—®é¢˜

**è§£å†³æ–¹æ³•**:
```bash
# ç­‰å¾…å‡ ç§’åé‡è¯•
sleep 5 && sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86

# æˆ–ä½¿ç”¨ä¸åŒçš„è¿æ¥å‚æ•°
sshpass -p 'jR74pQyDMTRt*eti7@' ssh -o ServerAliveInterval=60 root@156.229.163.86
```

### 2. ç«¯å£è¢«å ç”¨

**é”™è¯¯**: `EADDRINUSE: address already in use 0.0.0.0:3000`

**è§£å†³æ–¹æ³•**:

**æ¨èæ–¹å¼ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰**:
```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼Œä¼šè‡ªåŠ¨å¤„ç†ç«¯å£å ç”¨
./scripts/deploy.sh
```

**æ‰‹åŠ¨å¤„ç†**:
```bash
# SSH åˆ°æœåŠ¡å™¨
sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86

# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -tlnp | grep :3000

# æ€æ‰è¿›ç¨‹
pkill -f 'node.*server.js'

# æˆ–ä½¿ç”¨ PID
kill -9 <PID>

# ç­‰å¾… 2 ç§’
sleep 2

# é‡æ–°å¯åŠ¨æœåŠ¡
cd /opt/claude-relay-service
npm run service:start:daemon
```

### 3. API è¿”å› 401 Unauthorized

**é—®é¢˜åˆ†æ**:
1. **ç®¡ç†å‘˜é¡µé¢ 401**: `adminToken` è¿‡æœŸæˆ–æ— æ•ˆ
2. **ç”¨æˆ·é¡µé¢ 401**: `auth_token` è¿‡æœŸæˆ–æ— æ•ˆ
3. **API è·¯å¾„é”™è¯¯**: ä½¿ç”¨äº†é”™è¯¯çš„è®¤è¯æ–¹å¼

**è§£å†³æ–¹æ³•**:

#### æ£€æŸ¥ Cookie
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
document.cookie.split('; ').forEach(c => console.log(c));
```

#### æ£€æŸ¥ API è·¯å¾„
- `/admin/*` API éœ€è¦ `adminToken`
- `/users/*` API éœ€è¦ `auth_token`

#### é‡æ–°ç™»å½•
```typescript
// æ¸…é™¤æ—§ token
document.cookie = 'adminToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
// è·³è½¬åˆ°ç™»å½•é¡µ
router.push('/admin/login');
```

### 4. å‰ç«¯æ„å»ºå¤±è´¥

**é”™è¯¯**: TypeScript ç±»å‹é”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
cd commercial-website
npm run build 2>&1 | grep "Type error"

# å¸¸è§é—®é¢˜ï¼š
# 1. ç¼ºå°‘ç±»å‹å®šä¹‰
# 2. æ¥å£ä¸åŒ¹é…
# 3. ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å±æ€§
```

**ä¿®å¤ç¤ºä¾‹**:
```typescript
// âŒ é”™è¯¯ï¼šå±æ€§ä¸å­˜åœ¨
const data = await adminApi.someMethod();
data.nonExistentProperty; // Type error

// âœ… æ­£ç¡®ï¼šæ£€æŸ¥å±æ€§æˆ–ä½¿ç”¨å¯é€‰é“¾
data?.existingProperty;
```

### 5. Vercel éƒ¨ç½²å¤±è´¥

**å¸¸è§åŸå› **:
1. æ„å»ºé”™è¯¯ï¼ˆTypeScriptã€ESLintï¼‰
2. ç¯å¢ƒå˜é‡æœªé…ç½®
3. ä¾èµ–å®‰è£…å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# æœ¬åœ°æµ‹è¯•æ„å»º
npm run build

# æ£€æŸ¥ç¯å¢ƒå˜é‡
# åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­ç¡®è®¤ï¼š
# NEXT_PUBLIC_API_BASE_URL=https://api.codewith.site

# æ¸…é™¤ç¼“å­˜é‡æ–°éƒ¨ç½²
npx vercel --prod --yes --force
```

### 6. API è°ƒç”¨è¿”å›ç©ºæ•°æ®

**é—®é¢˜**: åç«¯è¿”å›æ•°æ®ï¼Œä½†å‰ç«¯æ˜¾ç¤ºä¸ºç©º

**åŸå› **: æ•°æ®æ ¼å¼ä¸ä¸€è‡´

**è§£å†³æ–¹æ³•**:
```typescript
// åç«¯å¯èƒ½è¿”å›ä¸åŒæ ¼å¼
const data = await adminApi.getResource();

// å…¼å®¹å¤šç§æ ¼å¼
const list = Array.isArray(data) 
  ? data 
  : (data.data || data.resources || data.items || []);

// æ·»åŠ æ—¥å¿—è°ƒè¯•
console.log('ğŸ“¦ Raw API response:', data);
console.log('ğŸ“¦ Extracted list:', list);
```

### 7. æœåŠ¡å¯åŠ¨åç«‹å³å´©æºƒ

**æ£€æŸ¥æ­¥éª¤**:
```bash
# SSH åˆ°æœåŠ¡å™¨
sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86

cd /opt/claude-relay-service

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -50 logs/service-error.log

# å¸¸è§é—®é¢˜ï¼š
# 1. MongoDB è¿æ¥å¤±è´¥
# 2. Redis è¿æ¥å¤±è´¥
# 3. ç¯å¢ƒå˜é‡ç¼ºå¤±
# 4. ç«¯å£è¢«å ç”¨
```

### 8. æ•°æ®åº“è¿æ¥å¤±è´¥

**MongoDB è¿æ¥é”™è¯¯**:
```bash
# æ£€æŸ¥ MongoDB æœåŠ¡
systemctl status mongod

# é‡å¯ MongoDB
systemctl restart mongod

# æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
cat /opt/claude-relay-service/.env | grep MONGODB_URI
```

**Redis è¿æ¥é”™è¯¯**:
```bash
# æ£€æŸ¥ Redis æœåŠ¡
systemctl status redis

# æµ‹è¯•è¿æ¥
redis-cli ping

# é‡å¯ Redis
systemctl restart redis
```

### 9. å‰ç«¯é¡µé¢ç™½å±

**å¯èƒ½åŸå› **:
1. JavaScript é”™è¯¯
2. API è°ƒç”¨å¤±è´¥
3. è·¯ç”±é…ç½®é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
2. æŸ¥çœ‹ Console æ ‡ç­¾çš„é”™è¯¯ä¿¡æ¯
3. æŸ¥çœ‹ Network æ ‡ç­¾çš„ API è¯·æ±‚çŠ¶æ€
4. æ£€æŸ¥ React DevTools

### 10. æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**æ£€æŸ¥é¡¹**:
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /opt/claude-relay-service/

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ä¸Šä¼ ç›®å½•
ls -la /opt/claude-relay-service/uploads/
```

## æ—¥å¿—æŸ¥çœ‹æŠ€å·§

### ä½¿ç”¨æ—¥å¿—å·¥å…·ï¼ˆæ¨èï¼‰
```bash
# æŸ¥çœ‹æœ€è¿‘æ—¥å¿—
./scripts/view-logs.sh

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
./scripts/view-logs.sh -f

# åªçœ‹é”™è¯¯
./scripts/view-logs.sh -e

# æœç´¢ç‰¹å®šå…³é”®è¯
./scripts/view-logs.sh -s "MongoDB"

# å®æ—¶è·Ÿè¸ªé”™è¯¯ï¼ˆæœ€æœ‰ç”¨ï¼‰
./scripts/view-logs.sh -f -e
```

### æ‰‹åŠ¨æŸ¥çœ‹æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
tail -f /opt/claude-relay-service/logs/service.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -100 /opt/claude-relay-service/logs/error.log

# æœç´¢ç‰¹å®šé”™è¯¯
grep -i error /opt/claude-relay-service/logs/service.log | tail -20

# æŸ¥çœ‹æœ€è¿‘çš„è¯·æ±‚æ—¥å¿—
tail -100 /opt/claude-relay-service/logs/requests.log
```

### å‰ç«¯æ—¥å¿—
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°å¯ç”¨è¯¦ç»†æ—¥å¿—
localStorage.setItem('debug', 'true');

// æŸ¥çœ‹æ‰€æœ‰ API è¯·æ±‚
// æ‰“å¼€ Network æ ‡ç­¾ï¼Œç­›é€‰ XHR/Fetch
```

## æ€§èƒ½é—®é¢˜æ’æŸ¥

### åç«¯æ€§èƒ½
```bash
# æŸ¥çœ‹ CPU å’Œå†…å­˜ä½¿ç”¨
top

# æŸ¥çœ‹ Node è¿›ç¨‹
ps aux | grep node

# æŸ¥çœ‹è¿æ¥æ•°
netstat -an | grep :3000 | wc -l
```

### å‰ç«¯æ€§èƒ½
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
// æŸ¥çœ‹é¡µé¢åŠ è½½æ—¶é—´
performance.timing.loadEventEnd - performance.timing.navigationStart

// æŸ¥çœ‹èµ„æºåŠ è½½
performance.getEntriesByType('resource')
```

## ç´§æ€¥æ¢å¤æµç¨‹

### åç«¯æœåŠ¡å´©æºƒ

**å¿«é€Ÿè¯Šæ–­**:
```bash
# 1. æ£€æŸ¥ç¯å¢ƒé…ç½®
./scripts/check-env.sh

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
./scripts/view-logs.sh -e -n 50

# 3. è¿è¡Œå¥åº·æ£€æŸ¥
curl https://api.codewith.site/health
```

**æ¢å¤æ­¥éª¤**:
```bash
# æ–¹å¼ 1: é‡æ–°éƒ¨ç½²ï¼ˆæ¨èï¼‰
./scripts/deploy.sh

# æ–¹å¼ 2: æ‰‹åŠ¨é‡å¯
sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86 \
  "cd /opt/claude-relay-service && npm run service:restart"

# æ–¹å¼ 3: å›æ»šåˆ°å¤‡ä»½
sshpass -p 'jR74pQyDMTRt*eti7@' ssh root@156.229.163.86 \
  "cd /opt/claude-relay-service && \
   ls -lh backups/ && \
   tar -xzf backups/backup_YYYYMMDD_HHMMSS.tar.gz && \
   npm run service:restart"
```

**éªŒè¯æ¢å¤**:
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•
export ADMIN_TOKEN="your-token"
node scripts/test-api.js
```

### å‰ç«¯éƒ¨ç½²é—®é¢˜
```bash
# åœ¨ Vercel Dashboard ä¸­å›æ»šåˆ°ä¸Šä¸€ä¸ªæˆåŠŸçš„éƒ¨ç½²
# æˆ–é‡æ–°éƒ¨ç½²
cd commercial-website
npx vercel --prod --yes
```

## è”ç³»å’Œæ”¯æŒ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š
1. æ£€æŸ¥ç›¸å…³æ–‡æ¡£: `claude-relay-service/æ–‡æ¡£ä¸­å¿ƒ/` æˆ– `commercial-website/æ–‡æ¡£ä¸­å¿ƒ/`
2. æŸ¥çœ‹æœåŠ¡å™¨é…ç½®è„šæœ¬: [21-æœåŠ¡å™¨é…ç½®è„šæœ¬.md](mdc:claude-relay-service/æ–‡æ¡£ä¸­å¿ƒ/21-æœåŠ¡å™¨é…ç½®è„šæœ¬.md)
3. æŸ¥çœ‹éƒ¨ç½²æŒ‡å—: [23-å¿«é€Ÿéƒ¨ç½²æŒ‡å—.md](mdc:claude-relay-service/æ–‡æ¡£ä¸­å¿ƒ/23-å¿«é€Ÿéƒ¨ç½²æŒ‡å—.md)
